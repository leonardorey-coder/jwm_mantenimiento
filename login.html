<!doctype html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Login - JW Marriott Sistema de Mantenimiento</title>

  <!-- Detectar modo standalone (PWA instalada) y establecer tema -->
  <script>
    (function () {
      // Detectar modo standalone
      if (
        window.navigator.standalone === true ||
        window.matchMedia('(display-mode: standalone)').matches
      ) {
        document.documentElement.classList.add('standalone-mode');
      }
      // Establecer tema
      const theme = localStorage.getItem('theme') || 'light';
      document.documentElement.setAttribute('data-theme', theme);
    })();
  </script>

  <link rel="stylesheet" href="css/style.css" />
  <link rel="stylesheet" href="css/login-style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />

  <!-- Favicon para navegadores -->
  <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192x192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="icons/icon-512x512.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png" />
  <link rel="shortcut icon" href="icons/favicon.ico" />
</head>

<body class="login-body">
  <div class="login-container">
    <!-- Logo Container con animaci√≥n -->
    <div class="login-logo-container">
      <img src="logo_high.png" alt="JW Marriott Logo" class="login-logo" />
      <h1 class="login-title">SGSOM</h1>
      <p class="login-subtitle">
        Sistema de Gesti√≥n de Servicios, de Mantenimiento, Habitaciones y
        Espacios Comunes
      </p>
    </div>

    <!-- Switch de Tema en el login -->
    <!-- <div class="theme-toggle-login">
            <button id="themeToggleLogin" class="theme-toggle-btn">
                <i class="fas fa-moon"></i>
            </button>
        </div> -->

    <!-- Toggle: Iniciar Sesi√≥n / Registrarse -->
    <div class="login-toggle">
      <button class="toggle-button active" data-mode="login">
        Iniciar Sesi√≥n
      </button>
      <button class="toggle-button" data-mode="register">Registrarse</button>
    </div>

    <!-- Formulario de Login -->
    <form id="loginForm" class="auth-form active">
      <div class="form-group">
        <label for="loginEmail">
          <i class="fas fa-id-badge"></i>
          Correo o No. de Empleado
        </label>
        <input type="text" id="loginEmail" class="form-input" placeholder="correo@ejemplo.com o Emp-123" required />
      </div>

      <div class="form-group">
        <label for="loginPassword">
          <i class="fas fa-lock"></i>
          Contrase√±a
        </label>
        <div class="password-input-container">
          <input type="password" id="loginPassword" class="form-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required />
          <button type="button" class="toggle-password" data-target="loginPassword">
            <i class="fas fa-eye"></i>
          </button>
        </div>
      </div>

      <div class="form-options">
        <label class="remember-me">
          <input type="checkbox" id="rememberMe" />
          <span>Recordarme</span>
        </label>
        <a href="#" class="forgot-password">¬øOlvidaste tu contrase√±a?</a>
      </div>

      <button type="submit" class="btn-submit">
        <i class="fas fa-sign-in-alt"></i>
        Iniciar Sesi√≥n
      </button>
    </form>

    <!-- Formulario de Registro -->
    <form id="registerForm" class="auth-form">
      <div class="register-form-grid">
        <div class="form-group">
          <label for="registerNombre">
            <i class="fas fa-user"></i>
            Nombre completo <span class="required-asterisk">*</span>
          </label>
          <input type="text" id="registerNombre" class="form-input" placeholder="Juan Leonardo Cruz" required />
        </div>

        <div class="form-group">
          <label for="registerEmail">
            <i class="fas fa-envelope"></i>
            Correo electr√≥nico <span class="required-asterisk">*</span>
          </label>
          <input type="email" id="registerEmail" class="form-input" placeholder="correo@ejemplo.com" required />
        </div>

        <div class="form-group">
          <label for="registerTelefono">
            <i class="fas fa-phone"></i>
            Tel√©fono (opcional)
          </label>
          <input type="tel" id="registerTelefono" class="form-input" placeholder="624 237 0000" />
        </div>

        <div class="form-group">
          <label for="registerRol">
            <i class="fas fa-user-tag"></i>
            Rol <span class="required-asterisk">*</span>
          </label>
          <div class="select-wrapper">
            <select id="registerRol" class="form-input" required>
              <option value="">Selecciona un rol</option>
              <option value="TECNICO">T√©cnico</option>
              <option value="SUPERVISOR">Supervisor</option>
              <!-- TODO: Futura implementaci√≥n - Permitir registro como ADMIN
                   Cuando se implemente, agregar: <option value="ADMIN">Administrador</option>
                   Nota: Requiere validaci√≥n adicional y posible aprobaci√≥n del administrador principal -->
            </select>
          </div>
        </div>

        <div class="form-group">
          <label for="registerPassword">
            <i class="fas fa-lock"></i>
            Contrase√±a <span class="required-asterisk">*</span>
          </label>
          <div class="password-input-container">
            <input type="password" id="registerPassword" class="form-input" placeholder="M√≠nimo 8 caracteres" required minlength="8" />
            <button type="button" class="toggle-password" data-target="registerPassword">
              <i class="fas fa-eye"></i>
            </button>
          </div>
        </div>

        <div class="form-group">
          <label for="registerConfirmPassword">
            <i class="fas fa-lock"></i>
            Confirmar contrase√±a <span class="required-asterisk">*</span>
          </label>
          <div class="password-input-container">
            <input type="password" id="registerConfirmPassword" class="form-input" placeholder="Repite la contrase√±a" required minlength="8" />
            <button type="button" class="toggle-password" data-target="registerConfirmPassword">
              <i class="fas fa-eye"></i>
            </button>
          </div>
        </div>
      </div>

      <div class="form-options">
        <label class="remember-me">
          <input type="checkbox" id="registerTerms" required />
          <span>Acepto los <a href="#" id="termsLink" class="terms-link">t√©rminos y condiciones</a></span>
        </label>
      </div>

      <button type="submit" class="btn-submit">
        <i class="fas fa-user-plus"></i>
        Crear cuenta
      </button>
    </form>

    <!-- Mensaje de error/√©xito -->
    <div id="authMessage" class="auth-message"></div>

    <!-- Modal: Olvidaste tu contrase√±a -->
    <div class="forgot-password-modal" id="forgotPasswordModal">
      <div class="forgot-card">
        <button class="forgot-close" id="closeForgotModal" aria-label="Cerrar modal de recuperaci√≥n">
          <i class="fas fa-times"></i>
        </button>
        <div class="forgot-header">
          <div class="forgot-icon">
            <i class="fas fa-unlock-alt"></i>
          </div>
          <div>
            <h3>¬øOlvidaste tu contrase√±a?</h3>
            <p>
              Enviaremos tu solicitud al administrador para restablecer el
              acceso.
            </p>
          </div>
        </div>

        <form id="forgotPasswordForm" class="forgot-form" novalidate>
          <label for="forgotName">
            <span>Nombre completo</span>
            <input type="text" id="forgotName" placeholder="Ej. Juan Leonardo Cruz" required />
          </label>

          <label for="forgotEmail">
            <span>Correo corporativo</span>
            <input type="email" id="forgotEmail" placeholder="correo@jwmarriott.com" required />
          </label>

          <label for="forgotPhone">
            <span>Tel√©fono o extensi√≥n (opcional)</span>
            <input type="text" id="forgotPhone" placeholder="Ej. 624 237 0000" />
          </label>

          <label for="forgotNotes">
            <span>Comentarios para el administrador (opcional)</span>
            <textarea id="forgotNotes" rows="3" placeholder="Agrega contexto para acelerar el soporte"></textarea>
          </label>

          <div class="forgot-admin-card" id="forgotAdminCard">
            <div class="admin-icon">
              <i class="fas fa-headset"></i>
            </div>
            <div class="admin-contact">
              <p>
                Tu solicitud ser√° atendida por
                <strong id="forgotAdminName">Fidel Cruz Lozada</strong>.
              </p>
              <a href="mailto:fcruz@grupodiestra.com" id="forgotAdminEmail">fcruz@grupodiestra.com</a>
              <span id="forgotAdminPhone">+52 624 237 1063</span>
            </div>
          </div>

          <div class="forgot-feedback" id="forgotPasswordFeedback"></div>

          <button type="submit" class="btn-submit">
            <i class="fas fa-paper-plane"></i>
            Enviar solicitud
          </button>
        </form>
      </div>
    </div>

    <!-- Modal cambio obligatorio de contrase√±a -->
    <div class="force-password-modal" id="forcePasswordModal">
      <div class="force-password-card">
        <div class="force-password-header">
          <i class="fas fa-shield-alt"></i>
          <div>
            <h3>Actualiza tu contrase√±a</h3>
            <p>
              Por seguridad,
              <span id="forcePasswordUser">tu cuenta</span> debe establecer
              una nueva contrase√±a antes de continuar.
            </p>
          </div>
        </div>
        <form id="forcePasswordForm" class="force-password-form" novalidate>
          <label>
            <span>Nueva contrase√±a</span>
            <input type="password" id="forceNewPassword" placeholder="M√≠nimo 8 caracteres" required />
          </label>
          <label>
            <span>Confirmar nueva contrase√±a</span>
            <input type="password" id="forceConfirmPassword" placeholder="Repite la contrase√±a" required />
          </label>
          <div class="force-password-feedback" id="forcePasswordFeedback"></div>
          <button type="submit" class="btn-submit">
            <i class="fas fa-key"></i>
            Cambiar contrase√±a y continuar
          </button>
        </form>
      </div>
    </div>

    <!-- Footer -->
    <div class="login-footer">
      <p>&copy; 2026 JW Marriott Los Cabos. Todos los derechos reservados.</p>
    </div>
  </div>

  <!-- IndexedDB Manager - Sistema de almacenamiento local -->
  <script type="module">
    // Importar m√≥dulos de IndexedDB
    import dbManager from './js/indexeddb-manager.js';
    import storageHelper from './js/storage-helper.js';

    // Exponer globalmente para compatibilidad
    window.dbManager = dbManager;
    window.storageHelper = storageHelper;

    // Inicializar IndexedDB antes de cargar login
    console.log('üîß [Login] Inicializando sistema de almacenamiento...');

    Promise.all([dbManager.init(), storageHelper.init()])
      .then(() => {
        console.log('‚úÖ [Login] Sistema de almacenamiento inicializado');

        // Cargar script de login
        const script = document.createElement('script');
        script.src = 'js/login-jwt.js?v=' + Date.now();
        script.onload = () =>
          console.log('‚úÖ [Login] Script de login cargado');
        script.onerror = (error) =>
          console.error('‚ùå [Login] Error cargando script:', error);
        document.body.appendChild(script);
      })
      .catch((error) => {
        console.error('‚ùå [Login] Error al inicializar storage:', error);

        // Cargar de todas formas (fallback)
        const script = document.createElement('script');
        script.src = 'js/login-jwt.js?v=' + Date.now();
        script.onload = () =>
          console.log('‚úÖ [Login] Script cargado en modo fallback');
        document.body.appendChild(script);
      });
  </script>
</body>

</html>