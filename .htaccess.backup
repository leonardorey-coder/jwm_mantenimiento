# ==============================================
# CONFIGURACIÓN BÁSICA DE .HTACCESS
# Sistema de Mantenimiento de Cuartos
# ==============================================

# Habilitar mod_rewrite
RewriteEngine On

# ==============================================
# SEGURIDAD BÁSICA
# ==============================================

# Proteger archivos sensibles
<FilesMatch "\.(htaccess|htpasswd|ini|log|sh|sql|conf|yml|yaml|env)$">
    Order Allow,Deny
    Deny from all
</FilesMatch>

# Ocultar información del servidor (solo headers que funcionan en .htaccess)
Header always unset X-Powered-By
Header always set X-Content-Type-Options nosniff
Header always set X-Frame-Options DENY
Header always set X-XSS-Protection "1; mode=block"

# ==============================================
# CACHEO BÁSICO
# ==============================================

# Cache para imágenes y recursos estáticos
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType image/png "access plus 1 month"
    ExpiresByType image/jpg "access plus 1 month"
    ExpiresByType image/jpeg "access plus 1 month"
    ExpiresByType text/css "access plus 1 week"
    ExpiresByType text/javascript "access plus 1 week"
    ExpiresByType application/javascript "access plus 1 week"
</IfModule>

# ==============================================
# TIPOS MIME PARA PWA
# ==============================================

<IfModule mod_mime.c>
    AddType application/manifest+json .webmanifest .manifest
    AddType text/cache-manifest .appcache
</IfModule>
    AddOutputFilterByType DEFLATE application/x-javascript
    AddOutputFilterByType DEFLATE application/json
    AddOutputFilterByType DEFLATE application/manifest+json
</IfModule>

# Caché del navegador
<IfModule mod_expires.c>
    ExpiresActive On
    
    # Archivos de imagen
    ExpiresByType image/jpg "access plus 1 month"
    ExpiresByType image/jpeg "access plus 1 month"
    ExpiresByType image/gif "access plus 1 month"
    ExpiresByType image/png "access plus 1 month"
    ExpiresByType image/svg+xml "access plus 1 month"
    ExpiresByType image/webp "access plus 1 month"
    ExpiresByType image/x-icon "access plus 1 year"
    
    # CSS y JavaScript
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    ExpiresByType application/x-javascript "access plus 1 month"
    
    # Fuentes
    ExpiresByType font/woff "access plus 1 year"
    ExpiresByType font/woff2 "access plus 1 year"
    ExpiresByType application/font-woff "access plus 1 year"
    ExpiresByType application/font-woff2 "access plus 1 year"
    
    # HTML y otros
    ExpiresByType text/html "access plus 0 seconds"
    ExpiresByType application/json "access plus 0 seconds"
    ExpiresByType application/xml "access plus 0 seconds"
    ExpiresByType text/xml "access plus 0 seconds"
</IfModule>

# Control de caché con headers
<IfModule mod_headers.c>
    # Cache-Control para archivos estáticos
    <FilesMatch "\.(css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$">
        Header set Cache-Control "public, max-age=2592000"
    </FilesMatch>
    
    # No cache para archivos dinámicos
    <FilesMatch "\.(php|html)$">
        Header set Cache-Control "no-cache, no-store, must-revalidate"
        Header set Pragma "no-cache"
        Header set Expires "0"
    </FilesMatch>
    
    # Headers de seguridad
    Header always set X-Content-Type-Options nosniff
    Header always set X-Frame-Options DENY
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
</IfModule>

# ==============================================
# CONFIGURACIÓN DE TIPOS MIME
# ==============================================

# Configurar tipos MIME específicos
<IfModule mod_mime.c>
    # Web App Manifest
    AddType application/manifest+json .webmanifest .json
    
    # Service Worker
    AddType application/javascript .js
    
    # Web fonts
    AddType font/woff .woff
    AddType font/woff2 .woff2
    
    # SVG
    AddType image/svg+xml .svg
    
    # JSON
    AddType application/json .json
</IfModule>

# ==============================================
# CONFIGURACIÓN PWA
# ==============================================

# Configuración especial para manifest.json
<Files "manifest.json">
    Header set Content-Type "application/manifest+json"
    Header set Cache-Control "public, max-age=86400"
</Files>

# Configuración especial para Service Worker
<Files "sw.js">
    Header set Content-Type "application/javascript"
    Header set Cache-Control "no-cache, no-store, must-revalidate"
    Header set Pragma "no-cache"
    Header set Expires "0"
</Files>

# ==============================================
# REDIRECCIONES Y ENRUTAMIENTO
# ==============================================

# Forzar HTTPS (descomenta si usas SSL)
# RewriteCond %{HTTPS} off
# RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

# Redirigir www a no-www (opcional)
# RewriteCond %{HTTP_HOST} ^www\.(.*)$ [NC]
# RewriteRule ^(.*)$ https://%1/$1 [R=301,L]

# Manejar trailing slashes
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_URI} (.+)/$
RewriteRule ^(.+)/$ /$1 [R=301,L]

# Si la petición es a un archivo o directorio existente, servirlo directamente
RewriteCond %{REQUEST_FILENAME} -f [OR]
RewriteCond %{REQUEST_FILENAME} -d
RewriteRule ^ - [L]

# Enrutamiento específico para APIs y archivos especiales
RewriteRule ^api/(.*)$ api.php?route=$1 [QSA,L]
RewriteRule ^obtener_cuarto\.php$ obtener_cuarto.php [L]
RewriteRule ^obtener_mantenimiento\.php$ obtener_mantenimiento.php [L]
RewriteRule ^procesar\.php$ procesar.php [L]

# Redirigir todo lo demás al enrutador principal
RewriteRule ^ index.php [QSA,L]

# ==============================================
# CONFIGURACIÓN DE ERRORES
# ==============================================

# Páginas de error personalizadas
ErrorDocument 404 /index.php
ErrorDocument 403 /index.php
ErrorDocument 500 /index.php

# ==============================================
# CONFIGURACIÓN DE DIRECTORIO
# ==============================================

# Opciones de directorio
Options -Indexes -MultiViews +FollowSymLinks

# Archivos índice por defecto
DirectoryIndex index.php index.html

# Configuración de charset
AddDefaultCharset UTF-8

# ==============================================
# LÍMITES Y CONFIGURACIÓN PHP
# ==============================================

# Configuraciones PHP (si están permitidas)
<IfModule mod_php.c>
    php_value upload_max_filesize 10M
    php_value post_max_size 10M
    php_value max_execution_time 300
    php_value max_input_vars 3000
    php_value memory_limit 256M
</IfModule>

# ==============================================
# CONFIGURACIÓN ADICIONAL
# ==============================================

# Deshabilitar ETags para mejor control de caché
FileETag None

# Configuración de módulos opcionales
<IfModule mod_rewrite.c>
    # Variables de entorno para debugging (solo en desarrollo)
    # SetEnv APPLICATION_ENV development
</IfModule>

# Fin de configuración
