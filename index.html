<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>JW Marriott - Sistema de Mantenimiento</title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
    />
    <meta
      name="description"
      content="Sistema de Gestión de Servicios para JW Marriott"
    />
    <meta
      name="keywords"
      content="JW Marriott, Sistema de Mantenimiento, Gestión de Servicios"
    />
    <meta name="author" content="JW Marriott Los Cabos" />
    <meta name="robots" content="index, follow" />
    <meta name="googlebot" content="index, follow" />

    <!-- Detectar modo standalone (PWA instalada) -->
    <script>
      if (
        window.navigator.standalone === true ||
        window.matchMedia('(display-mode: standalone)').matches
      ) {
        document.documentElement.classList.add('standalone-mode');
      }
    </script>

    <link rel="stylesheet" href="views/checklist/checklist-styles.css" />
    <link rel="stylesheet" href="css/style.css" />
    <link rel="stylesheet" href="css/style-users.css" />
    <link rel="stylesheet" href="css/style-users-blocked.css" />

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json" />

    <!-- Favicon para navegadores -->
    <link
      rel="icon"
      type="image/png"
      sizes="192x192"
      href="icons/icon-192x192.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="512x512"
      href="icons/icon-512x512.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="icons/favicon-32x32.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="icons/favicon-16x16.png"
    />
    <link rel="shortcut icon" href="icons/favicon.ico" />

    <!-- Meta tags para PWA -->
    <meta name="theme-color" content="#1E1E1E" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="JW Mantto" />
    <link rel="apple-touch-icon" href="icons/icon-192x192.png" />

    <!-- Apple Touch Icons -->
    <link
      rel="apple-touch-icon"
      sizes="192x192"
      href="icons/icon-192x192.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="icons/apple-touch-icon.png"
    />
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#1E1E1E" />

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json" crossorigin="use-credentials" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <meta name="application-name" content="JW Mantto" />

    <!-- CDN Libraries -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
    <link rel="stylesheet" href="https://unpkg.com/aos@2.3.1/dist/aos.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
  </head>

  <body>
    <!-- Header Premium -->
    <header class="premium-header">
      <div class="header-content">
        <!-- Columna Izquierda: Usuario -->
        <div class="header-left">
          <div class="user-info">
            <div>
              <span class="user-name" id="userName">Usuario</span>
              <span class="user-role" id="userRole">Rol</span>
            </div>
          </div>
        </div>

        <!-- Columna Centro: Logo -->
        <div class="header-center">
          <div class="logo">
            <img
              src="logo_low.png"
              alt="JW Marriott Los Cabos"
              class="logo-high"
            />
          </div>
        </div>

        <!-- Columna Derecha: Controles -->
        <div class="header-right">
          <!-- Botón de configuración de fondo -->
          <button
            onclick="abrirModalConfigFondo()"
            class="download-btn btn-config-fondo-header"
            title="Configurar fondo de pantalla"
          >
            <i class="fas fa-image"></i>
          </button>
          <!-- Botones de descarga de la app -->
          <button
            onclick="downloadPortable(this)"
            class="download-btn download-portable"
            title="Descargar versión Portable (desde GitHub)"
          >
            <i class="fas fa-download"></i>
          </button>
          <button
            onclick="downloadInstaller(this)"
            class="download-btn download-installer"
            title="Descargar versión Instalable (desde GitHub)"
          >
            <i class="fas fa-box-open"></i>
          </button>
          <button
            onclick="openIphoneGuide()"
            class="download-btn download-ios-guide"
            title="Guía de instalación en iPhone (tutorial-instalacion-pwa-iphone.jpeg)"
          >
            <i class="fas fa-mobile-alt"></i>
          </button>
          <!-- Botón para recargar página / verificar actualizaciones -->
          <button
            id="checkUpdatesBtn"
            class="update-check-btn"
            title="Recargar página"
          >
            <i class="fas fa-sync-alt"></i>
            <span class="update-badge" style="display: none">!</span>
          </button>
          <button id="logoutBtn" class="logout-btn" title="Cerrar sesión">
            <i class="fas fa-sign-out-alt"></i>
          </button>
        </div>
      </div>

      <!-- Navigation Menu - Debajo del header -->
      <nav class="premium-nav">
        <div class="menu">
          <a
            href="#"
            class="link active"
            data-tab="habitaciones"
            id="nav-habitaciones"
          >
            <div class="link-icon">
              <i class="fas fa-bed"></i>
            </div>
            <div class="link-title">
              <span>Habitaciones</span>
            </div>
          </a>

          <a href="#" class="link" data-tab="espacios" id="nav-espacios">
            <div class="link-icon">
              <i class="fas fa-building"></i>
            </div>
            <div class="link-title">
              <span>Espacios Comunes</span>
            </div>
          </a>

          <a href="#" class="link" data-tab="tareas" id="nav-tareas">
            <div class="link-icon">
              <i class="fas fa-tasks"></i>
            </div>
            <div class="link-title">
              <span>Tareas</span>
            </div>
          </a>

          <a href="#" class="link" data-tab="sabana" id="nav-sabana">
            <div class="link-icon">
              <i class="fas fa-table"></i>
            </div>
            <div class="link-title">
              <span>Sábana</span>
            </div>
          </a>

          <a href="#" class="link" data-tab="checklist" id="nav-checklist">
            <div class="link-icon">
              <i class="fas fa-clipboard-check"></i>
            </div>
            <div class="link-title">
              <span>Checklist</span>
            </div>
          </a>

          <a
            href="#"
            class="link admin-only"
            data-tab="usuarios"
            id="nav-usuarios"
          >
            <div class="link-icon">
              <i class="fas fa-users-cog"></i>
            </div>
            <div class="link-title">
              <span>Usuarios</span>
            </div>
          </a>
        </div>
      </nav>
    </header>

    <!-- Navigation Menu Móvil - Abajo en móviles -->
    <nav class="premium-nav-mobile">
      <div class="menu">
        <a
          href="#"
          class="link active"
          data-tab="habitaciones"
          id="nav-habitaciones-mobile"
        >
          <div class="link-icon">
            <i class="fas fa-bed"></i>
          </div>
          <div class="link-title">
            <span>Habitaciones</span>
          </div>
        </a>

        <a href="#" class="link" data-tab="espacios" id="nav-espacios-mobile">
          <div class="link-icon">
            <i class="fas fa-building"></i>
          </div>
          <div class="link-title">
            <span>Espacios</span>
          </div>
        </a>

        <a href="#" class="link" data-tab="tareas" id="nav-tareas-mobile">
          <div class="link-icon">
            <i class="fas fa-tasks"></i>
          </div>
          <div class="link-title">
            <span>Tareas</span>
          </div>
        </a>

        <a href="#" class="link" data-tab="sabana" id="nav-sabana-mobile">
          <div class="link-icon">
            <i class="fas fa-table"></i>
          </div>
          <div class="link-title">
            <span>Sábana</span>
          </div>
        </a>

        <a href="#" class="link" data-tab="checklist" id="nav-checklist-mobile">
          <div class="link-icon">
            <i class="fas fa-clipboard-check"></i>
          </div>
          <div class="link-title">
            <span>Checklist</span>
          </div>
        </a>

        <a
          href="#"
          class="link admin-only"
          data-tab="usuarios"
          id="nav-usuarios-mobile"
        >
          <div class="link-icon">
            <i class="fas fa-users-cog"></i>
          </div>
          <div class="link-title">
            <span>Usuarios</span>
          </div>
        </a>
      </div>
    </nav>

    <div class="contenedor">
      <!-- Tab Content: Habitaciones -->
      <div class="tab-content active" id="tab-habitaciones" data-aos="fade-in">
        <h1 class="titulos t-principal">Sistema de Gestión de Mantenimiento</h1>
        <h2 class="titulos t-secundario">Gerencia de Mantenimiento</h2>

        <!-- Panel de búsqueda y filtros (ancho completo) -->
        <div class="panel panel-filtros" data-aos="fade-down">
          <div class="filtros-header-mobile">
            <button
              class="filtros-toggle-btn"
              id="toggleFiltros"
              aria-label="Mostrar/Ocultar filtros"
            >
              <i class="fas fa-filter"></i>
              <span>Filtros</span>
              <i class="fas fa-chevron-down toggle-icon"></i>
            </button>
          </div>
          <div class="busqueda-filtros" id="contenedorFiltros">
            <div class="campo-busqueda premium-search">
              <i class="fas fa-search icono-busqueda"></i>
              <input
                type="text"
                id="buscarCuarto"
                placeholder="Buscar nombre de habitación..."
              />
            </div>
            <div class="campo-busqueda premium-search">
              <i class="fas fa-tools icono-busqueda"></i>
              <input
                type="text"
                id="buscarAveria"
                placeholder="Buscar nombre de avería (serv-010)..."
              />
            </div>
            <div class="select-container premium-select">
              <select id="filtroEdificio" name="edificio">
                <option value="">Todos los edificios</option>
                <!-- Los edificios se cargarán dinámicamente -->
              </select>
              <i class="fas fa-chevron-down icono-select"></i>
            </div>
            <div
              class="select-container premium-select"
              data-semaforo-wrapper="prioridad"
            >
              <span
                class="semaforo-indicator semaforo-select-indicator"
                aria-hidden="true"
              ></span>
              <select
                id="filtroPrioridad"
                name="prioridad"
                data-semaforo-select="prioridad"
              >
                <option value="">Todas las prioridades</option>
                <option value="baja">Baja</option>
                <option value="media">Media</option>
                <option value="alta">Alta</option>
              </select>
              <i class="fas fa-chevron-down icono-select"></i>
            </div>
            <div
              class="select-container premium-select"
              data-semaforo-wrapper="estado"
            >
              <span
                class="semaforo-indicator semaforo-select-indicator"
                aria-hidden="true"
              ></span>
              <select
                id="filtroEstado"
                name="estado"
                data-semaforo-select="estado"
              >
                <option value="">Todos los estados</option>
                <option value="disponible">Disponible</option>
                <option value="ocupado">Ocupado</option>
                <option value="mantenimiento">Mantenimiento</option>
                <option value="fuera_servicio">Fuera de Servicio</option>
              </select>
              <i class="fas fa-chevron-down icono-select"></i>
            </div>
          </div>
        </div>

        <!-- Selector de vistas para móvil -->
        <div class="mobile-view-selector">
          <button class="view-btn active" data-view="habitaciones">
            <i class="fas fa-bed"></i>
            <span>Habitaciones</span>
          </button>
          <button class="view-btn" data-view="alertas">
            <i class="fas fa-bell"></i>
            <span>Alertas</span>
          </button>
        </div>

        <!-- Estructura de vista duo -->
        <div class="vista-duo">
          <!-- Columna izquierda (3/4) - Lista de cuartos -->
          <div class="columna columna-principal">
            <ul class="lista-cuartos brutalist-grid" id="listaCuartos">
              <!-- Los cuartos se cargarán dinámicamente con sus mantenimientos -->
            </ul>
            <div
              class="habitaciones-pagination"
              id="habitacionesPagination"
              aria-live="polite"
            ></div>
            <!-- Mensaje para cuando no hay resultados de búsqueda/filtro -->
            <div
              id="mensajeNoResultados"
              class="mensaje-no-cuartos"
              style="display: none; margin-top: 20px"
            >
              <i class="fas fa-search"></i>
              <p>
                No se encontraron habitaciones con los criterios seleccionados
              </p>
            </div>
          </div>

          <!-- Columna derecha (1/4) - Formulario para agregar mantenimientos -->
          <div class="columna columna-lateral">
            <!-- Panel de Vista Rápida de Alertas -->
            <div
              class="panel panel-vista-rutinas gradient-card"
              data-aos="fade-left"
              data-aos-delay="100"
            >
              <h2><i class="fas fa-bell"></i> Alertas Programadas</h2>
              <div class="alert-search-container premium-search">
                <i class="fas fa-search icono-busqueda"></i>
                <input
                  onkeyup="
                    buscarAlertas(
                      document.querySelectorAll('#listaVistaRutinas li'),
                      document.querySelectorAll(
                        '#listaVistaRutinas li .rutina-descripcion'
                      ),
                      this.value,
                      document.getElementById('mensaje-no-alertas-encontradas')
                    )
                  "
                  type="search"
                  name="buscadorVistaAlertas"
                  id="buscadorVistaAlertas"
                  placeholder="Buscar alertas..."
                />
              </div>
              <ul class="lista-vista-rutinas" id="listaVistaRutinas">
                <!-- Las alertas se cargarán dinámicamente -->
                <li class="mensaje-cargando">Cargando alertas...</li>
              </ul>
              <p
                id="mensaje-no-alertas-encontradas"
                class="mensaje-no-items"
                style="
                  display: none;
                  text-align: center;
                  margin-top: 10px;
                  font-style: italic;
                  color: #78768d;
                "
              >
                <i class="fas fa-search"></i> No hay alertas que coincidan con
                la búsqueda
              </p>
            </div>

            <!-- Panel de Alertas Emitidas -->
            <div
              class="panel panel-alertas-emitidas gradient-card"
              data-aos="fade-left"
              data-aos-delay="300"
            >
              <h2><i class="fas fa-calendar-check"></i> Alertas del Día</h2>
              <div class="alert-search-container premium-search">
                <i class="fas fa-search icono-busqueda"></i>
                <input
                  onkeyup="
                    buscarAlertas(
                      document.querySelectorAll('#listaAlertasEmitidas li'),
                      document.querySelectorAll(
                        '#listaAlertasEmitidas li .alerta-descripcion'
                      ),
                      this.value,
                      document.getElementById('mensaje-no-alertas-dia-buscador')
                    )
                  "
                  id="buscadorAlertasDia"
                  type="search"
                  placeholder="Buscar alertas del día..."
                />
              </div>
              <ul class="lista-alertas-emitidas" id="listaAlertasEmitidas">
                <!-- Las alertas emitidas se cargarán aquí por JavaScript -->
                <li class="mensaje-cargando">Cargando alertas...</li>
              </ul>
              <p
                id="mensaje-no-alertas-emitidas"
                class="mensaje-no-items"
                style="
                  display: none;
                  text-align: center;
                  margin-top: 10px;
                  font-style: italic;
                  color: #78768d;
                "
              >
                <i class="fas fa-check-circle"></i> No hay alertas pendientes
              </p>
              <p
                id="mensaje-no-alertas-dia-buscador"
                class="mensaje-no-items"
                style="
                  display: none;
                  text-align: center;
                  margin-top: 10px;
                  font-style: italic;
                  color: #78768d;
                "
              >
                <i class="fas fa-search"></i> No hay alertas que coincidan con
                la búsqueda
              </p>
            </div>

            <!-- Panel de Historial de Alertas Emitidas -->
            <div
              class="panel panel-historial-alertas gradient-card"
              data-aos="fade-left"
              data-aos-delay="200"
            >
              <h2>
                <i class="fas fa-history"></i> Historial de Alertas Emitidas
              </h2>
              <div class="alert-search-container premium-search">
                <i class="fas fa-search icono-busqueda"></i>
                <input
                  onkeyup="
                    buscarAlertas(
                      document.querySelectorAll('#listaHistorialAlertas li'),
                      document.querySelectorAll(
                        '#listaHistorialAlertas li .alerta-descripcion'
                      ),
                      this.value,
                      document.getElementById('mensaje-no-buscador-historial')
                    )
                  "
                  id="buscadorHistorialAlertas"
                  type="search"
                  placeholder="Buscar en historial..."
                />
              </div>
              <ul class="lista-historial-alertas" id="listaHistorialAlertas">
                <!-- El historial completo de alertas emitidas se cargará dinámicamente -->
                <li class="mensaje-cargando">Cargando historial...</li>
              </ul>
              <p
                id="mensaje-no-historial"
                class="mensaje-no-items"
                style="
                  display: none;
                  text-align: center;
                  margin-top: 10px;
                  font-style: italic;
                  color: #78768d;
                "
              >
                <i class="fas fa-inbox"></i> No hay alertas emitidas registradas
              </p>
              <p
                id="mensaje-no-buscador-historial"
                class="mensaje-no-items"
                style="
                  display: none;
                  text-align: center;
                  margin-top: 10px;
                  font-style: italic;
                  color: #78768d;
                "
              >
                <i class="fas fa-search"></i> No hay alertas que coincidan con
                la búsqueda
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Tab Content: Espacios Comunes -->
      <div class="tab-content" id="tab-espacios" data-aos="fade-in">
        <h1 class="titulos t-principal">Bitácora de Espacios Comunes</h1>
        <h2 class="titulos t-secundario">Control de Áreas Públicas</h2>

        <!-- Filtros superiores -->
        <div class="panel panel-filtros" data-aos="fade-down">
          <div class="filtros-header-mobile">
            <button
              class="filtros-toggle-btn"
              id="toggleFiltrosEspacios"
              aria-label="Mostrar/Ocultar filtros"
            >
              <i class="fas fa-filter"></i>
              <span>Filtros</span>
              <i class="fas fa-chevron-down toggle-icon"></i>
            </button>
          </div>
          <div
            class="busqueda-filtros usuarios-filtros"
            id="contenedorFiltrosEspacios"
          >
            <div class="campo-busqueda premium-search">
              <i class="fas fa-search icono-busqueda"></i>
              <input
                type="text"
                id="buscarEspacio"
                placeholder="Buscar espacio..."
              />
            </div>
            <div class="campo-busqueda premium-search">
              <i class="fas fa-tools icono-busqueda"></i>
              <input
                type="text"
                id="buscarServicioEspacio"
                placeholder="Buscar por servicio..."
              />
            </div>
            <div class="select-container premium-select">
              <select id="filtroEdificioEspacio">
                <option value="">Todos los edificios</option>
                <!-- Los edificios se cargarán dinámicamente -->
              </select>
              <i class="fas fa-chevron-down icono-select"></i>
            </div>
            <div class="select-container premium-select">
              <select id="filtroTipoEspacio">
                <option value="">Todos los espacios</option>
                <option value="comun">Áreas Comunes</option>
                <option value="recreativo">Recreación</option>
                <option value="restaurante">Restaurantes</option>
                <option value="eventos">Eventos</option>
                <option value="servicios">Servicios</option>
                <option value="exterior">Exterior</option>
              </select>
              <i class="fas fa-chevron-down icono-select"></i>
            </div>
            <div
              class="select-container premium-select"
              data-semaforo-wrapper="prioridad"
            >
              <span
                class="semaforo-indicator semaforo-select-indicator"
                aria-hidden="true"
              ></span>
              <select
                id="filtroPrioridadEspacio"
                data-semaforo-select="prioridad"
              >
                <option value="">Todas las prioridades</option>
                <option value="baja">Baja</option>
                <option value="media">Media</option>
                <option value="alta">Alta</option>
              </select>
              <i class="fas fa-chevron-down icono-select"></i>
            </div>
            <div
              class="select-container premium-select"
              data-semaforo-wrapper="estado"
            >
              <span
                class="semaforo-indicator semaforo-select-indicator"
                aria-hidden="true"
              ></span>
              <select id="filtroEstadoEspacio" data-semaforo-select="estado">
                <option value="">Todos los estados</option>
                <option value="disponible">Disponible</option>
                <option value="mantenimiento">En mantenimiento</option>
                <option value="ocupado">Ocupado</option>
                <option value="fuera_servicio">Fuera de servicio</option>
              </select>
              <i class="fas fa-chevron-down icono-select"></i>
            </div>
          </div>
        </div>

        <!-- Selector de vistas para móvil -->
        <div class="mobile-view-selector">
          <button class="view-btn active" data-view="habitaciones">
            <i class="fas fa-building"></i>
            <span>Espacios</span>
          </button>
          <button class="view-btn" data-view="alertas">
            <i class="fas fa-bell"></i>
            <span>Alertas</span>
          </button>
        </div>

        <div class="vista-duo">
          <!-- Columna principal -->
          <div class="columna columna-principal">
            <ul
              class="lista-cuartos brutalist-grid"
              id="listaEspaciosComunes"
              data-aos="fade-up"
            >
              <!-- Los espacios se cargarán dinámicamente -->
            </ul>
            <div
              id="mensajeNoEspacios"
              class="mensaje-no-cuartos"
              style="display: none"
            >
              <i class="fas fa-search"></i>
              <p>No se encontraron espacios con los criterios seleccionados</p>
            </div>
            <div
              class="habitaciones-pagination"
              id="espaciosPagination"
              aria-live="polite"
            ></div>
          </div>

          <!-- Columna lateral -->
          <div class="columna columna-lateral">
            <!-- Panel de Alertas de Espacios Comunes -->
            <div
              class="panel panel-vista-rutinas gradient-card"
              data-aos="fade-left"
              data-aos-delay="100"
            >
              <h2><i class="fas fa-bell"></i> Alertas de Espacios</h2>
              <div class="alert-search-container premium-search">
                <i class="fas fa-search icono-busqueda"></i>
                <input
                  type="search"
                  id="buscadorAlertasEspacios"
                  placeholder="Buscar alertas..."
                />
              </div>
              <ul class="lista-vista-rutinas" id="listaAlertasEspacios">
                <!-- Las alertas de espacios se cargarán dinámicamente -->
                <li class="mensaje-cargando">Cargando alertas...</li>
              </ul>
              <p
                id="mensaje-no-alertas-espacios"
                class="mensaje-no-items"
                style="
                  display: none;
                  text-align: center;
                  margin-top: 10px;
                  font-style: italic;
                  color: #78768d;
                "
              >
                <i class="fas fa-check-circle"></i> No hay alertas pendientes
              </p>
            </div>

            <!-- Panel de Alertas Emitidas de Espacios -->
            <div
              class="panel panel-alertas-emitidas gradient-card"
              data-aos="fade-left"
              data-aos-delay="300"
            >
              <h2><i class="fas fa-calendar-check"></i> Alertas del Día</h2>
              <div class="alert-search-container premium-search">
                <i class="fas fa-search icono-busqueda"></i>
                <input
                  type="search"
                  id="buscadorAlertasDiaEspacios"
                  placeholder="Buscar alertas del día..."
                />
              </div>
              <ul
                class="lista-alertas-emitidas"
                id="listaAlertasEmitidasEspacios"
              >
                <!-- Las alertas emitidas se cargarán aquí por JavaScript -->
                <li class="mensaje-cargando">Cargando alertas...</li>
              </ul>
              <p
                id="mensaje-no-alertas-emitidas-espacios"
                class="mensaje-no-items"
                style="
                  display: none;
                  text-align: center;
                  margin-top: 10px;
                  font-style: italic;
                  color: #78768d;
                "
              >
                <i class="fas fa-check-circle"></i> No hay alertas pendientes
              </p>
            </div>

            <!-- Panel de Estadísticas (NUEVO) -->
            <div
              class="card-container usuarios-stats-container espacios-stats-container"
              data-aos="fade-left"
              data-aos-delay="100"
            >
              <div
                class="pixar-card usuario-stats-card espacios-stats-card"
                role="article"
                aria-labelledby="espaciosStatsTitle"
              >
                <div class="card-header">
                  <div class="card-avatar"></div>
                  <p class="card-username" id="espaciosStatsTitle">
                    Panel de Espacios
                  </p>
                </div>
                <div class="card-image-area">
                  <div class="card-image-placeholder">
                    <div
                      class="pixar-progress"
                      id="espaciosStatsProgress"
                      data-percent="0%"
                      style="--progress-value: 0%"
                    ></div>
                  </div>
                  <p class="card-caption">
                    <span id="espaciosStatsCaption">Total de espacios: 0</span>
                    <span
                      class="card-caption-highlight"
                      id="espaciosStatsHighlight"
                      >Disponibles: 0 · Ocupados: 0 · En mantto.: 0</span
                    >
                  </p>
                </div>
                <div class="card-actions">
                  <button
                    class="action-button like-button"
                    type="button"
                    aria-label="Espacios disponibles"
                  >
                    <div class="action-button-metric">
                      <span class="metric-label">Disponibles</span>
                      <strong id="espaciosStatsDisponibles">0</strong>
                    </div>
                  </button>
                  <button
                    class="action-button share-button"
                    type="button"
                    aria-label="Espacios ocupados"
                  >
                    <div class="action-button-metric">
                      <span class="metric-label">Ocupados</span>
                      <strong id="espaciosStatsOcupados">0</strong>
                    </div>
                  </button>
                  <button
                    class="action-button"
                    type="button"
                    aria-label="Espacios en mantenimiento"
                  >
                    <div class="action-button-metric">
                      <span class="metric-label">Mantto.</span>
                      <strong id="espaciosStatsMantenimiento">0</strong>
                    </div>
                  </button>
                  <button
                    class="action-button comment-button"
                    type="button"
                    aria-label="Espacios fuera de servicio"
                  >
                    <div class="action-button-metric">
                      <span class="metric-label">Fuera</span>
                      <strong id="espaciosStatsFuera">0</strong>
                    </div>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Tab Content: Tareas -->
      <div class="tab-content" id="tab-tareas" data-aos="fade-in">
        <h1 class="titulos t-principal">Centro de Tareas</h1>
        <h2 class="titulos t-secundario">Seguimiento Operativo</h2>

        <!-- Panel de búsqueda y filtros -->
        <div class="panel panel-filtros" data-aos="fade-down">
          <div class="filtros-header-mobile">
            <button
              class="filtros-toggle-btn"
              id="toggleFiltrosTareas"
              aria-label="Mostrar/Ocultar filtros"
            >
              <i class="fas fa-filter"></i>
              <span>Filtros</span>
              <i class="fas fa-chevron-down toggle-icon"></i>
            </button>
          </div>
          <div
            class="busqueda-filtros usuarios-filtros"
            id="contenedorFiltrosTareas"
          >
            <div class="campo-busqueda premium-search">
              <i class="fas fa-search icono-busqueda"></i>
              <input
                type="text"
                id="buscarTarea"
                placeholder="Buscar tarea..."
              />
            </div>
            <div class="select-container premium-select">
              <select id="filtroRolTarea">
                <option value="para-mi" selected>Para mí</option>
                <option value="mi-rol">Mi rol</option>
                <option value="todos">Todos los roles</option>
                <option value="admin">Administrador</option>
                <option value="supervisor">Supervisor</option>
                <option value="tecnico">Técnico</option>
              </select>
              <i class="fas fa-chevron-down icono-select"></i>
            </div>
            <div
              class="select-container premium-select"
              data-semaforo-wrapper="estado-tarea"
            >
              <span
                class="semaforo-indicator semaforo-select-indicator"
                aria-hidden="true"
              ></span>
              <select
                id="filtroEstadoTarea"
                data-semaforo-select="estado-tarea"
              >
                <option value="">Todos los estados</option>
                <option value="pendiente">Pendiente</option>
                <option value="en_proceso">En proceso</option>
                <option value="completada">Completada</option>
                <option value="cancelada">Cancelada</option>
              </select>
              <i class="fas fa-chevron-down icono-select"></i>
            </div>
            <div
              class="select-container premium-select"
              data-semaforo-wrapper="prioridad"
            >
              <span
                class="semaforo-indicator semaforo-select-indicator"
                aria-hidden="true"
              ></span>
              <select
                id="filtroPrioridadTarea"
                data-semaforo-select="prioridad"
              >
                <option value="">Todas las prioridades</option>
                <option value="alta">Alta</option>
                <option value="media">Media</option>
                <option value="baja">Baja</option>
              </select>
              <i class="fas fa-chevron-down icono-select"></i>
            </div>
            <div class="select-container premium-select">
              <select id="filtroTagTarea">
                <option value="">Todos los tags</option>
              </select>
              <i class="fas fa-chevron-down icono-select"></i>
            </div>
            <button
              type="button"
              class="btn-nueva-tarea"
              id="btnNuevaTarea"
              onclick="abrirModalCrearTarea()"
            >
              <i class="fas fa-plus"></i>
              <span>Nueva</span>
            </button>
          </div>
        </div>

        <!-- Selector de vistas para móvil -->
        <div class="mobile-view-selector">
          <button class="view-btn active" data-view="tareas">
            <i class="fas fa-tasks"></i>
            <span>Tareas</span>
          </button>
          <button class="view-btn" data-view="alertas">
            <i class="fas fa-bell"></i>
            <span>Alertas</span>
          </button>
        </div>

        <!-- Vista duo -->
        <div class="vista-duo">
          <!-- Columna principal -->
          <div class="columna columna-principal">
            <!-- Grid de tareas en formato habitaciones -->
            <ul
              class="lista-cuartos brutalist-grid"
              id="listaTareas"
              data-aos="fade-up"
            >
              <!-- Las tarjetas se inyectan dinámicamente -->
            </ul>
            <div
              class="habitaciones-pagination"
              id="tareasPagination"
              aria-live="polite"
            ></div>
            <div
              id="mensajeNoTareas"
              class="mensaje-no-cuartos"
              style="display: none"
            >
              <i class="fas fa-check-double"></i>
              <p>No hay tareas con los filtros seleccionados</p>
            </div>
          </div>

          <!-- Columna lateral -->
          <div class="columna columna-lateral">
            <!-- Resumen por rol -->
            <div
              class="panel panel-alertas-espacios gradient-card"
              data-aos="fade-left"
            >
              <div class="panel-header-alertas">
                <h2>
                  <i class="fas fa-chart-pie"></i> Resumen ·
                  <span id="tareasResumenRol" class="rol-label-header"
                    >Mi Rol</span
                  >
                </h2>
              </div>
              <ul
                class="lista-alertas-espacios lista-resumen-sin-scroll"
                id="tareasResumenLista"
              >
                <li
                  class="alerta-espacio-item resumen-tarea-item-mejorado"
                  data-resumen-filtro="pendiente"
                >
                  <div class="alerta-espacio-header">
                    <div class="alerta-espacio-badge">
                      <i class="fas fa-clock"></i>
                      <span>Pendientes</span>
                    </div>
                    <span
                      class="badge-numero-simple pendiente"
                      id="tareasResumenPendientes"
                      >0</span
                    >
                  </div>
                  <p class="alerta-espacio-descripcion">
                    Tareas sin iniciar o próximas a vencer
                  </p>
                </li>
                <li
                  class="alerta-espacio-item resumen-tarea-item-mejorado"
                  data-resumen-filtro="en_proceso"
                >
                  <div class="alerta-espacio-header">
                    <div class="alerta-espacio-badge">
                      <i class="fas fa-spinner"></i>
                      <span>En Proceso</span>
                    </div>
                    <span
                      class="badge-numero-simple proceso"
                      id="tareasResumenEnProceso"
                      >0</span
                    >
                  </div>
                  <p class="alerta-espacio-descripcion">
                    Tareas actualmente en ejecución
                  </p>
                </li>
                <li
                  class="alerta-espacio-item resumen-tarea-item-mejorado"
                  data-resumen-filtro="completada"
                >
                  <div class="alerta-espacio-header">
                    <div class="alerta-espacio-badge">
                      <i class="fas fa-check-circle"></i>
                      <span>Completadas</span>
                    </div>
                    <span
                      class="badge-numero-simple completada"
                      id="tareasResumenCompletadas"
                      >0</span
                    >
                  </div>
                  <p class="alerta-espacio-descripcion">
                    Tareas finalizadas exitosamente
                  </p>
                </li>
                <li
                  class="alerta-espacio-item resumen-tarea-item-mejorado"
                  data-resumen-filtro="cancelada"
                >
                  <div class="alerta-espacio-header">
                    <div class="alerta-espacio-badge">
                      <i class="fas fa-ban"></i>
                      <span>Canceladas</span>
                    </div>
                    <span
                      class="badge-numero-simple cancelada"
                      id="tareasResumenCanceladas"
                      >0</span
                    >
                  </div>
                  <p class="alerta-espacio-descripcion">
                    Tareas canceladas por decisión operativa
                  </p>
                </li>
                <li
                  class="alerta-espacio-item resumen-tarea-item-mejorado item-urgente"
                  data-resumen-filtro="urgente"
                >
                  <div class="alerta-espacio-header">
                    <div class="alerta-espacio-badge">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span>Urgentes</span>
                    </div>
                    <span
                      class="badge-numero-simple urgente"
                      id="tareasResumenUrgentes"
                      >0</span
                    >
                  </div>
                  <p class="alerta-espacio-descripcion">
                    Alta prioridad o vencidas
                  </p>
                </li>
              </ul>
              <div class="alerta-extra-resumen">
                <i class="fas fa-tasks"></i> Total asignadas:
                <strong id="tareasResumenTotal">0</strong>
              </div>
            </div>

            <!-- Panel de Servicios/Alertas -->
            <div
              class="panel panel-alertas-espacios panel-servicios-tareas gradient-card"
              data-aos="fade-left"
              data-aos-delay="60"
            >
              <div class="panel-header-alertas">
                <h2>
                  <i class="fas fa-tools"></i> Servicios ·
                  <span id="serviciosResumenRol" class="rol-label-header"
                    >Para Mí</span
                  >
                </h2>
              </div>
              <ul
                class="lista-alertas-espacios lista-servicios-tareas"
                id="listaServiciosTareas"
              >
                <li class="mensaje-cargando">Cargando servicios...</li>
              </ul>
              <p
                id="mensajeNoServiciosTareas"
                class="mensaje-no-items"
                style="display: none"
              >
                <i class="fas fa-check-circle"></i> No hay averías o alertas
                asignadas
              </p>
              <div class="alerta-extra-resumen">
                <i class="fas fa-wrench"></i> Total:
                <strong id="serviciosTareasTotal">0</strong>
              </div>
            </div>

            <!-- Tarjeta Pixar Stats -->
            <!-- <div class="card-container usuarios-stats-container espacios-stats-container" data-aos="fade-left"
                        data-aos-delay="80">
                        <div class="pixar-card usuario-stats-card espacios-stats-card" role="article"
                            aria-labelledby="tareasStatsTitle">
                            <div class="card-header">
                                <div class="card-avatar"></div>
                                <p class="card-username" id="tareasStatsTitle">Monitor Operativo</p>
                            </div>
                            <div class="card-image-area">
                                <div class="card-image-placeholder">
                                    <div class="pixar-progress" id="tareasStatsProgress" data-percent="0%"
                                        style="--progress-value:0%"></div>
                                </div>
                                <p class="card-caption">
                                    <span id="tareasStatsCaption">Total de tareas: 0</span>
                                    <span class="card-caption-highlight" id="tareasStatsHighlight">0 completadas · 0
                                        pendientes</span>
                                </p>
                            </div>
                            <div class="card-actions">
                                <button class="action-button like-button" type="button" aria-label="Tareas pendientes">
                                    <div class="action-button-metric">
                                        <span class="metric-label">Pendientes</span>
                                        <strong id="tareasStatsPendientes">0</strong>
                                    </div>
                                </button>
                                <button class="action-button" type="button" aria-label="Tareas activas">
                                    <div class="action-button-metric">
                                        <span class="metric-label">Activas</span>
                                        <strong id="tareasStatsActivas">0</strong>
                                    </div>
                                </button>
                                <button class="action-button comment-button" type="button"
                                    aria-label="Tareas completadas">
                                    <div class="action-button-metric">
                                        <span class="metric-label">Completadas</span>
                                        <strong id="tareasStatsCompletadas">0</strong>
                                    </div>
                                </button>
                                <button class="action-button" type="button" aria-label="Tareas canceladas">
                                    <div class="action-button-metric">
                                        <span class="metric-label">Canceladas</span>
                                        <strong id="tareasStatsCanceladas">0</strong>
                                    </div>
                                </button>
                            </div>
                        </div>
                    </div> -->

            <!-- Timeline de vencimientos -->
            <div
              class="panel panel-alertas-espacios gradient-card"
              data-aos="fade-left"
              data-aos-delay="120"
            >
              <div class="panel-header-alertas">
                <h2><i class="fas fa-clock"></i> Próximos vencimientos</h2>
              </div>
              <ul
                class="lista-alertas-espacios lista-timeline-vencimientos"
                id="tareasTimeline"
              >
                <li class="mensaje-cargando">Sincronizando...</li>
              </ul>
              <p
                id="mensajeNoTimeline"
                class="mensaje-no-items"
                style="display: none"
              >
                <i class="fas fa-star"></i> Todo al día
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Tab Content: Inspecciones -->
      <div class="tab-content" id="tab-checklist" data-aos="fade-in">
        <h1 class="titulos t-principal">Checklist de Inspecciones</h1>
        <h2 class="titulos t-secundario">Control de Calidad de Habitaciones</h2>

        <div class="panel panel-filtros" data-aos="fade-down">
          <div class="checklist-categorias-toggle-bar">
            <button
              class="checklist-categorias-toggle"
              type="button"
              aria-expanded="false"
              id="toggleCategoriasBtn"
            >
              <i class="fas fa-sliders-h"></i>
              <span>Filtros por categoría</span>
              <i
                class="fas fa-chevron-down toggle-indicator"
                aria-hidden="true"
              ></i>
            </button>
          </div>
          <div
            class="checklist-categorias-wrapper"
            id="checklistCategoriasWrapper"
            data-mobile-open="false"
          >
            <div
              class="checklist-categorias-filtro"
              id="checklistCategoriasFiltro"
              role="tablist"
            >
              <button
                class="categoria-btn active"
                type="button"
                data-categoria=""
                aria-pressed="true"
                data-categoria-btn
              >
                <div class="categoria-btn-icon" aria-hidden="true">
                  <i class="fas fa-th"></i>
                </div>
                <div class="categoria-btn-text">
                  <span class="categoria-btn-label">Todas</span
                  ><small>Muestra todo</small>
                </div>
              </button>
            </div>
          </div>

          <div class="busqueda-filtros">
            <div class="campo-busqueda premium-search">
              <i class="fas fa-door-open icono-busqueda"></i>
              <input
                type="text"
                id="buscarHabitacionChecklist"
                placeholder="Buscar habitación (ej: A101, 203...)"
              />
            </div>

            <div class="campo-busqueda premium-search">
              <i class="fas fa-search icono-busqueda"></i>
              <input
                type="text"
                id="buscarChecklist"
                placeholder="Buscar ítem (ej: sofá, aire...)"
              />
            </div>

            <div class="select-container premium-select">
              <select id="filtroEdificioChecklist">
                <option value="">Todos los edificios</option>
              </select>
              <i class="fas fa-chevron-down icono-select"></i>
            </div>

            <div
              class="select-container premium-select"
              data-semaforo-wrapper="estado"
            >
              <span
                class="semaforo-indicator semaforo-select-indicator"
                aria-hidden="true"
              ></span>
              <select id="filtroEstadoChecklist" data-semaforo-select="estado">
                <option value="">Todos los estados</option>
                <option value="bueno">Bueno</option>
                <option value="regular">Regular</option>
                <option value="malo">Malo</option>
              </select>
              <i class="fas fa-chevron-down icono-select"></i>
            </div>

            <div class="select-container premium-select">
              <select id="filtroEditorChecklist" name="editor">
                <option value="">Todos los editores</option>
                <!-- Se carga dinámicamente desde la BD -->
              </select>
              <i class="fas fa-chevron-down icono-select"></i>
            </div>

            <div class="select-container premium-select">
              <select id="filtroImagenesChecklist" name="imagenes">
                <option value="">Todas las imágenes</option>
                <option value="con">Con imágenes</option>
                <option value="sin">Sin imágenes</option>
              </select>
              <i class="fas fa-chevron-down icono-select"></i>
            </div>
          </div>
        </div>

        <!-- Selector de vistas para móvil -->
        <div class="mobile-view-selector">
          <button class="view-btn active" data-view="checklists">
            <i class="fas fa-clipboard-check"></i>
            <span>Checklists</span>
          </button>
          <button class="view-btn" data-view="inspecciones">
            <i class="fas fa-clipboard-list"></i>
            <span>Inspecciones</span>
          </button>
        </div>

        <div class="vista-duo">
          <div class="columna columna-principal">
            <div class="checklist-grid" id="checklistGrid">
              <!-- Skeleton loading inicial -->
              <div class="skeleton-checklist-card">
                <div class="skeleton-checklist-header">
                  <div class="skeleton-room-badge"></div>
                  <div class="skeleton-edificio"></div>
                </div>
                <div class="skeleton-stats">
                  <div class="skeleton-stat">
                    <div
                      class="skeleton-stat-dot"
                      style="background: #22c55e"
                    ></div>
                    <div class="skeleton-stat-value"></div>
                  </div>
                  <div class="skeleton-stat">
                    <div
                      class="skeleton-stat-dot"
                      style="background: #f59e0b"
                    ></div>
                    <div class="skeleton-stat-value"></div>
                  </div>
                  <div class="skeleton-stat">
                    <div
                      class="skeleton-stat-dot"
                      style="background: #ef4444"
                    ></div>
                    <div class="skeleton-stat-value"></div>
                  </div>
                </div>
                <div class="skeleton-items-list">
                  <div class="skeleton-item">
                    <div class="skeleton-item-name" style="width: 60%"></div>
                    <div class="skeleton-item-buttons">
                      <div class="skeleton-btn"></div>
                      <div class="skeleton-btn"></div>
                      <div class="skeleton-btn"></div>
                    </div>
                  </div>
                  <div class="skeleton-item">
                    <div class="skeleton-item-name" style="width: 75%"></div>
                    <div class="skeleton-item-buttons">
                      <div class="skeleton-btn"></div>
                      <div class="skeleton-btn"></div>
                      <div class="skeleton-btn"></div>
                    </div>
                  </div>
                  <div class="skeleton-item">
                    <div class="skeleton-item-name" style="width: 50%"></div>
                    <div class="skeleton-item-buttons">
                      <div class="skeleton-btn"></div>
                      <div class="skeleton-btn"></div>
                      <div class="skeleton-btn"></div>
                    </div>
                  </div>
                </div>
                <div class="skeleton-footer">
                  <div class="skeleton-editor"></div>
                  <div class="skeleton-date"></div>
                </div>
              </div>
              <div
                class="skeleton-checklist-card"
                style="animation-delay: 0.1s"
              >
                <div class="skeleton-checklist-header">
                  <div class="skeleton-room-badge"></div>
                  <div class="skeleton-edificio"></div>
                </div>
                <div class="skeleton-stats">
                  <div class="skeleton-stat">
                    <div
                      class="skeleton-stat-dot"
                      style="background: #22c55e"
                    ></div>
                    <div class="skeleton-stat-value"></div>
                  </div>
                  <div class="skeleton-stat">
                    <div
                      class="skeleton-stat-dot"
                      style="background: #f59e0b"
                    ></div>
                    <div class="skeleton-stat-value"></div>
                  </div>
                  <div class="skeleton-stat">
                    <div
                      class="skeleton-stat-dot"
                      style="background: #ef4444"
                    ></div>
                    <div class="skeleton-stat-value"></div>
                  </div>
                </div>
                <div class="skeleton-items-list">
                  <div class="skeleton-item">
                    <div class="skeleton-item-name" style="width: 80%"></div>
                    <div class="skeleton-item-buttons">
                      <div class="skeleton-btn"></div>
                      <div class="skeleton-btn"></div>
                      <div class="skeleton-btn"></div>
                    </div>
                  </div>
                  <div class="skeleton-item">
                    <div class="skeleton-item-name" style="width: 65%"></div>
                    <div class="skeleton-item-buttons">
                      <div class="skeleton-btn"></div>
                      <div class="skeleton-btn"></div>
                      <div class="skeleton-btn"></div>
                    </div>
                  </div>
                  <div class="skeleton-item">
                    <div class="skeleton-item-name" style="width: 70%"></div>
                    <div class="skeleton-item-buttons">
                      <div class="skeleton-btn"></div>
                      <div class="skeleton-btn"></div>
                      <div class="skeleton-btn"></div>
                    </div>
                  </div>
                </div>
                <div class="skeleton-footer">
                  <div class="skeleton-editor"></div>
                  <div class="skeleton-date"></div>
                </div>
              </div>
            </div>

            <div
              class="habitaciones-pagination checklist-pagination"
              id="checklistPaginacion"
              aria-live="polite"
            ></div>
          </div>

          <div class="columna columna-lateral">
            <div class="panel formulario-mantenimiento-lateral brutalist-card">
              <div class="brutalist-card__header">
                <div class="brutalist-card__icon">
                  <i class="fas fa-layer-group"></i>
                </div>
                <div class="brutalist-card__alert">Nueva sección</div>
              </div>
              <p class="brutalist-card__message">
                Crea bloques adicionales (ej. "Decoración") y define ítems base.
              </p>
              <form id="formNuevaSeccionChecklist" class="brutalist-card__form">
                <label for="seccionNombre">Nombre de la sección</label>
                <input
                  type="text"
                  id="seccionNombre"
                  name="seccionNombre"
                  class="brutalist-input"
                  placeholder="Ej. Decoración"
                  required
                />
                <label for="seccionIcono">Icono</label>
                <div class="select-container premium-select">
                  <select
                    id="seccionIcono"
                    name="seccionIcono"
                    class="brutalist-input"
                  >
                    <option value="">Cargando iconos...</option>
                  </select>
                  <i class="fas fa-chevron-down icono-select"></i>
                </div>
                <label for="seccionItems"
                  >Ítems iniciales (coma o salto de línea)</label
                >
                <textarea
                  id="seccionItems"
                  name="seccionItems"
                  class="brutalist-input"
                  rows="3"
                  placeholder="Ej. Cuadros, Alfombras, Iluminación"
                ></textarea>
                <button
                  type="submit"
                  class="brutalist-card__button brutalist-card__button--mark"
                >
                  <i class="fas fa-plus-circle"></i> Guardar sección
                </button>
                <span
                  class="checklist-add-feedback"
                  id="checklistAddFeedback"
                  aria-live="polite"
                ></span>
              </form>
            </div>

            <div
              class="panel panel-alertas-espacios gradient-card checklist-recientes-panel"
            >
              <div class="panel-header-alertas">
                <h2><i class="fas fa-clipboard-list"></i> Inspecciones</h2>
              </div>
              <div class="checklist-recientes-search premium-search">
                <i class="fas fa-search icono-busqueda"></i
                ><input
                  type="text"
                  id="buscarInspeccionReciente"
                  placeholder="Buscar inspección..."
                />
              </div>
              <div class="lista-inspecciones-wrapper">
                <ul
                  class="lista-inspecciones-resumen"
                  id="listaInspeccionesRecientes"
                >
                  <li class="inspeccion-placeholder">
                    <i class="fas fa-spinner fa-spin"></i
                    ><span>Cargando inspecciones...</span>
                  </li>
                </ul>
              </div>
            </div>

            <div
              class="panel panel-vista-rutinas gradient-card"
              id="panelAccionesChecklist"
              style="display: none"
            >
              <h2><i class="fas fa-file-export"></i> Acciones</h2>
              <div class="panel-acciones-btns">
                <button
                  class="brutalist-card__button brutalist-card__button--mark"
                  id="btnExportarChecklistFiltrado"
                  title="Exportar según filtros activos"
                >
                  <i class="fas fa-filter"></i> Exportar Filtrado
                </button>
                <button
                  class="brutalist-card__button brutalist-card__button--read"
                  id="btnExportarChecklist"
                  title="Exportar todo el checklist"
                >
                  <i class="fas fa-file-excel"></i> Exportar Todo
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Tab Content: Sábana (Registro de Cambios a todos los cuartos confirmando cambio con checklist) -->
      <div class="tab-content" id="tab-sabana" data-aos="fade-in">
        <h1 class="titulos t-principal">Sábana de Servicios</h1>
        <h2 class="titulos t-secundario">
          Control de Servicios por Habitación
        </h2>

        <div class="filtros-container">
          <!-- Buscador de Sábana -->
          <div class="panel panel-filtros" data-aos="fade-down">
            <div class="filtros-header-mobile">
              <button
                class="filtros-toggle-btn"
                id="toggleFiltrosSabana"
                aria-label="Mostrar/Ocultar filtros"
              >
                <i class="fas fa-filter"></i>
                <span>Filtros</span>
                <i class="fas fa-chevron-down toggle-icon"></i>
              </button>
            </div>
            <div class="busqueda-filtros" id="contenedorFiltrosSabana">
              <div class="campo-busqueda premium-search">
                <i class="fas fa-search icono-busqueda"></i>
                <input
                  type="text"
                  id="buscarSabana"
                  placeholder="Buscar habitación o servicio..."
                  oninput="filterSabana()"
                />
              </div>
              <div class="select-container premium-select">
                <select
                  id="filtroEdificioSabana"
                  name="edificio"
                  onchange="filterSabana()"
                >
                  <option value="">Todos los edificios</option>
                </select>
                <i class="fas fa-chevron-down icono-select"></i>
              </div>
              <div class="select-container premium-select">
                <select
                  id="filtroServicioActual"
                  name="servicioActual"
                  onchange="cambiarServicioActual(this.value)"
                >
                  <option value="">-- Seleccionar servicio --</option>
                </select>
                <i class="fas fa-chevron-down icono-select"></i>
              </div>
              <div class="campo-busqueda premium-search">
                <i class="fas fa-hashtag icono-busqueda"></i>
                <input
                  type="text"
                  id="filtroSabanaId"
                  placeholder="ID sábana (sab-001)"
                  oninput="seleccionarSabanaPorId(this.value)"
                />
              </div>
              <div
                class="select-container premium-select"
                data-semaforo-wrapper="estadoServicio"
              >
                <span
                  class="semaforo-indicator semaforo-select-indicator"
                  aria-hidden="true"
                ></span>
                <select
                  id="filtroEstadoServicio"
                  name="estadoServicio"
                  data-semaforo-select="estadoServicio"
                  onchange="filterSabana()"
                >
                  <option value="">Todos los estados</option>
                  <option value="realizado">Realizado</option>
                  <option value="pendiente">Pendiente</option>
                </select>
                <i class="fas fa-chevron-down icono-select"></i>
              </div>
              <div class="select-container premium-select">
                <select
                  id="filtroPersonalSabana"
                  name="personalSabana"
                  onchange="filterSabana()"
                >
                  <option value="">Todo el personal</option>
                </select>
                <i class="fas fa-chevron-down icono-select"></i>
              </div>
              <div class="campo-busqueda premium-search">
                <i class="fas fa-comment-dots icono-busqueda"></i>
                <input
                  type="text"
                  id="filtroObservacionesSabana"
                  placeholder="Filtrar observaciones..."
                  oninput="filterSabana()"
                />
              </div>
            </div>
          </div>

          <!-- Bitácora de Servicios Card -->
          <div class="filtros-bitacora-card" data-aos="zoom-in">
            <div class="filtros-bitacora-header">
              <button
                class="sabana-id-tab"
                id="sabanaIdTab"
                type="button"
                title="Copiar ID de sábana"
              >
                <i class="fas fa-folder sabana-id-icon" aria-hidden="true"></i>
                <span id="sabanaIdValue">sab-000</span>
              </button>
              <h2 class="filtros-bitacora-title">
                <i class="fas fa-clipboard-list"></i>
                <span id="tituloServicioActual">Cargando Sábana...</span>
              </h2>
              <div class="filtros-bitacora-right">
                <div class="filtros-bitacora-periodo">
                  <i class="fas fa-calendar-alt"></i>
                  <span id="periodoActual">Periodo Actual</span>
                  <div
                    style="font-size: 0.8rem; margin-top: 0.3rem; opacity: 0.9"
                  >
                    <i class="fas fa-chart-bar"></i> Completados:
                    <span id="serviciosCompletados">0</span> /
                    <span id="serviciosTotales">0</span>
                  </div>
                  <div
                    id="sabanaCreadorInfo"
                    style="
                      font-size: 0.75rem;
                      margin-top: 0.3rem;
                      opacity: 0.8;
                      display: none;
                    "
                  >
                    <i class="fas fa-user"></i> Creado por:
                    <span id="sabanaCreadorNombre">-</span>
                  </div>
                </div>
                <button
                  class="btn-nueva-sabana"
                  type="button"
                  onclick="abrirModalNuevaSabana()"
                >
                  <i class="fas fa-plus"></i>
                  <span>Nueva</span>
                </button>
              </div>
              <div
                id="sabanaNotasContainer"
                class="sabana-notas-container"
                style="display: none"
              >
                <i class="fas fa-sticky-note"></i>
                <span
                  id="sabanaNotasTexto"
                  class="sabana-notas-editable"
                  title="Click para editar notas"
                ></span>
              </div>
            </div>

            <!-- Tabla de Servicios con diseño mejorado -->
            <div
              class="filtros-table-wrapper responsive-table"
              loading="lazy"
              style="max-height: 70vh; overflow-y: auto"
            >
              <table class="filtros-table">
                <thead>
                  <tr>
                    <th><i class="fas fa-building"></i> Edificio</th>
                    <th><i class="fas fa-door-closed"></i> Habitación</th>
                    <th><i class="fas fa-calendar"></i> Fecha Programada</th>
                    <th>
                      <i class="fas fa-calendar-check"></i> Fecha Realizado
                    </th>
                    <th><i class="fas fa-user"></i> Responsable</th>
                    <th style="text-align: center">
                      <i class="fas fa-comment"></i> Observaciones
                    </th>
                    <th><i class="fas fa-check-circle"></i> Realizado</th>
                  </tr>
                </thead>
                <tbody id="sabanaTableBody">
                  <!-- Los datos se cargarán dinámicamente -->
                  <tr>
                    <td colspan="8" class="mensaje-cargando">
                      Cargando datos...
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

            <!-- Botones de Acción -->
            <div class="filtros-actions-container">
              <button
                class="filtros-action-button excel supervisor-only"
                onclick="exportarSabanaExcel()"
              >
                <i class="fas fa-file-excel"></i>
                <div>
                  <div class="filtros-action-button-title">Exportar Excel</div>
                  <div class="filtros-action-button-subtitle">
                    Descargar registro completo
                  </div>
                </div>
              </button>

              <button
                class="filtros-action-button archive supervisor-only"
                onclick="archivarPeriodo()"
              >
                <i class="fas fa-archive"></i>
                <div>
                  <div class="filtros-action-button-title">
                    Archivar Periodo
                  </div>
                  <div class="filtros-action-button-subtitle">
                    Guardar periodo anterior
                  </div>
                </div>
              </button>

              <button
                class="filtros-action-button history"
                onclick="verHistorialServicios()"
              >
                <i class="fas fa-history"></i>
                <div>
                  <div class="filtros-action-button-title">Ver Historial</div>
                  <div class="filtros-action-button-subtitle">
                    Consultar periodos anteriores
                  </div>
                </div>
              </button>

              <button
                class="filtros-action-button delete admin-only"
                onclick="eliminarSabana()"
              >
                <i class="fas fa-trash-alt"></i>
                <div>
                  <div class="filtros-action-button-title">Eliminar Sábana</div>
                  <div class="filtros-action-button-subtitle">
                    Eliminar permanentemente
                  </div>
                </div>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Tab Content: Gestión de Usuarios (Solo Admin) -->
      <div class="tab-content admin-only" id="tab-usuarios" data-aos="fade-in">
        <h1 class="titulos t-principal">Gestión de Usuarios</h1>
        <h2 class="titulos t-secundario">Administración del Sistema</h2>

        <!-- Panel de búsqueda y filtros (ancho completo) -->
        <div
          class="panel panel-filtros panel-filtros-usuarios"
          data-aos="fade-down"
        >
          <div class="busqueda-filtros usuarios-filtros">
            <div class="campo-busqueda premium-search">
              <i class="fas fa-search icono-busqueda"></i>
              <input
                type="text"
                id="buscarUsuario"
                placeholder="Buscar por nombre, correo o departamento..."
              />
            </div>
            <div class="select-container premium-select">
              <select id="filtroRolUsuario" name="rol_usuario">
                <option value="">Todos los roles</option>
                <option value="admin">Administrador</option>
                <option value="supervisor">Supervisor</option>
                <option value="tecnico">Técnico</option>
              </select>
              <i class="fas fa-chevron-down icono-select"></i>
            </div>
            <div class="select-container premium-select">
              <select id="filtroEstadoUsuario" name="estado_usuario">
                <option value="">Todos los estados</option>
                <option value="activo">Activos</option>
                <option value="inactivo">Desactivados</option>
              </select>
              <i class="fas fa-chevron-down icono-select"></i>
            </div>
            <button
              type="button"
              class="btn-nuevo-usuario"
              onclick="abrirModalUsuario()"
            >
              <i class="fas fa-user-plus"></i>
              <span>Usuario</span>
            </button>
          </div>
        </div>

        <!-- Grid de Usuarios (ancho completo) -->
        <div class="usuarios-grid" id="usuariosGrid" data-aos="fade-up">
          <!-- Los usuarios se cargarán dinámicamente -->
          <div class="mensaje-cargando">Cargando usuarios...</div>
        </div>

        <div
          class="habitaciones-pagination usuarios-pagination"
          id="usuariosPagination"
          aria-live="polite"
        ></div>
      </div>
    </div>

    <!-- Modal Usuario (Crear/Editar) -->
    <div
      id="modalUsuario"
      class="modal-detalles modal-editar-tarea modal-usuario-form"
      style="display: none"
      aria-hidden="true"
    >
      <div class="modal-detalles-overlay" onclick="cerrarModalUsuario()"></div>
      <div class="modal-detalles-contenido tarea-edit-modal">
        <div class="modal-detalles-header">
          <div>
            <p class="modal-detalles-subtitulo" id="modalUsuarioSubtitulo">
              Nuevo usuario
            </p>
            <h3 id="modalUsuarioTitulo">Crear</h3>
          </div>
          <button class="modal-detalles-cerrar" onclick="cerrarModalUsuario()">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <form id="formUsuario" class="tarea-edit-form">
          <input type="hidden" id="usuarioIdEdicion" value="" />
          <div class="tarea-edit-grid">
            <div class="form-group full">
              <label for="nombreUsuario">Nombre completo</label>
              <input
                type="text"
                id="nombreUsuario"
                name="nombre"
                placeholder="Ej. Juan Pérez"
                required
              />
            </div>
            <div class="form-group full">
              <label for="correoUsuario">Correo corporativo</label>
              <input
                type="email"
                id="correoUsuario"
                name="email"
                placeholder="usuario@jwmarriott.com"
                required
              />
            </div>
            <div class="form-group">
              <label for="departamentoUsuario">Departamento</label>
              <input
                type="text"
                id="departamentoUsuario"
                name="departamento"
                placeholder="Ej. Mantenimiento"
              />
            </div>
            <div class="form-group">
              <label for="telefonoUsuario">Teléfono</label>
              <input
                type="tel"
                id="telefonoUsuario"
                name="telefono"
                placeholder="+52 624 000 0000"
              />
            </div>
            <div class="form-group">
              <label for="numeroEmpleadoUsuario">Número de empleado</label>
              <input
                type="text"
                id="numeroEmpleadoUsuario"
                name="numero_empleado"
                placeholder="EMP-00123"
              />
            </div>
            <div class="form-group">
              <label for="rolUsuario">Rol</label>
              <select id="rolUsuario" name="rol" required>
                <option value="">Selecciona un rol...</option>
                <option value="admin">Administrador</option>
                <option value="supervisor">Supervisor</option>
                <option value="tecnico">Técnico</option>
              </select>
            </div>
            <div class="form-group full">
              <label for="passwordUsuario">Contraseña temporal</label>
              <input
                type="password"
                id="passwordUsuario"
                name="password"
                placeholder="Mínimo 6 caracteres"
                minlength="6"
              />
              <small class="input-help" id="passwordHelp"
                >La contraseña temporal solo se solicita durante el registro
                inicial.</small
              >
            </div>
            <div class="form-group full checkbox-group">
              <label class="checkbox-label">
                <input
                  type="checkbox"
                  id="requiereCambioPassword"
                  name="requiere_cambio_password"
                  checked
                />
                <span class="checkbox-custom"></span>
                <span class="checkbox-text"
                  >El usuario debe cambiar su contraseña al acceder</span
                >
              </label>
            </div>
            <div class="form-group full">
              <label for="notasUsuario">Notas internas</label>
              <textarea
                id="notasUsuario"
                name="notas_admin"
                rows="3"
                placeholder="Notas para el equipo de administración"
              ></textarea>
            </div>
          </div>
          <div class="modal-detalles-acciones">
            <button
              type="button"
              class="btn-cuarto-action btn-tarea-light"
              onclick="cerrarModalUsuario()"
            >
              <i class="fas fa-times"></i> Cancelar
            </button>
            <button
              type="submit"
              class="btn-cuarto-action btn-tarea-accent"
              id="btnSubmitUsuario"
            >
              <i class="fas fa-user-plus"></i> <span>Crear usuario</span>
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal Detalle Usuario (Vista desde Card) -->
    <div
      id="modalDetalleUsuario"
      class="modal-detalles modal-detalle-usuario"
      style="display: none"
      aria-hidden="true"
    >
      <div
        class="modal-detalles-overlay"
        onclick="cerrarModalDetalleUsuario()"
      ></div>
      <div class="modal-detalles-contenido modal-usuario-detalle-content">
        <div class="modal-detalles-header detalle-usuario-header">
          <div class="detalle-usuario-avatar" id="detalleUsuarioAvatar">
            <i class="fas fa-user"></i>
          </div>
          <div class="detalle-usuario-header-info">
            <div class="detalle-usuario-header-top">
              <h3 id="detalleUsuarioNombre">Nombre del Usuario</h3>
              <span
                class="badge-rol detalle-usuario-badge"
                id="detalleUsuarioRolBadge"
                >TÉCNICO</span
              >
            </div>
            <span class="detalle-usuario-empleado" id="detalleUsuarioEmpleado"
              >EMP-00000</span
            >
          </div>
          <button
            class="modal-detalles-cerrar"
            onclick="cerrarModalDetalleUsuario()"
          >
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-detalles-body modal-usuario-detalle-body">
          <!-- Información de contacto -->
          <div class="detalle-usuario-seccion">
            <h4 class="detalle-usuario-seccion-titulo">
              <i class="fas fa-address-card"></i> Información de Contacto
            </h4>
            <div class="detalle-usuario-info-grid">
              <div class="detalle-usuario-info-item">
                <span class="detalle-usuario-label"
                  ><i class="fas fa-envelope"></i> Correo</span
                >
                <span class="detalle-usuario-valor" id="detalleUsuarioEmail"
                  >usuario@example.com</span
                >
              </div>
              <div class="detalle-usuario-info-item">
                <span class="detalle-usuario-label"
                  ><i class="fas fa-phone"></i> Teléfono</span
                >
                <span class="detalle-usuario-valor" id="detalleUsuarioTelefono"
                  >Sin registro</span
                >
              </div>
              <div class="detalle-usuario-info-item">
                <span class="detalle-usuario-label"
                  ><i class="fas fa-building"></i> Departamento</span
                >
                <span
                  class="detalle-usuario-valor"
                  id="detalleUsuarioDepartamento"
                  >Sin registro</span
                >
              </div>
            </div>
          </div>

          <!-- Información de sesiones -->
          <div class="detalle-usuario-seccion">
            <h4 class="detalle-usuario-seccion-titulo">
              <i class="fas fa-clock"></i> Actividad de Sesiones
            </h4>
            <!-- Indicador de última actividad con semáforo -->
            <div
              class="detalle-usuario-actividad"
              id="detalleUsuarioActividadContainer"
            >
              <div class="detalle-actividad-header">
                <i
                  class="fas fa-circle semaforo-gris"
                  id="detalleUsuarioSemaforoIcon"
                  title="Sin actividad"
                ></i>
                <span class="detalle-actividad-label">ÚLTIMA ACTIVIDAD</span>
              </div>
              <span
                class="detalle-actividad-valor"
                id="detalleUsuarioActividadRelativa"
                >Sin registro</span
              >
            </div>
            <div class="detalle-usuario-sesiones-resumen">
              <div class="detalle-usuario-sesion-stat hoy">
                <i class="fas fa-calendar-day stat-icon"></i>
                <div class="stat-content">
                  <span class="stat-numero" id="detalleUsuarioSesionesHoy"
                    >0</span
                  >
                  <span class="stat-label">Sesiones hoy</span>
                </div>
              </div>
              <div class="detalle-usuario-sesion-stat activas">
                <i class="fas fa-bolt stat-icon"></i>
                <div class="stat-content">
                  <span class="stat-numero" id="detalleUsuarioSesionesActivas"
                    >0</span
                  >
                  <span class="stat-label">Sesiones activas</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Notas administrativas (visible solo si hay notas) -->
          <div
            class="detalle-usuario-seccion detalle-usuario-notas-section"
            id="detalleUsuarioNotasSection"
            style="display: none"
          >
            <h4 class="detalle-usuario-seccion-titulo">
              <i class="fas fa-sticky-note"></i> Notas Administrativas
            </h4>
            <p class="detalle-usuario-notas-texto" id="detalleUsuarioNotas">
              Sin notas
            </p>
          </div>

          <!-- Estado del usuario (con switch editable) -->
          <div class="detalle-usuario-seccion detalle-usuario-estado-section">
            <h4 class="detalle-usuario-seccion-titulo">
              <i class="fas fa-toggle-on"></i> Estado del Usuario
            </h4>
            <div class="detalle-usuario-estado-container">
              <div class="checkbox-wrapper-35">
                <input
                  type="checkbox"
                  class="switch usuario-toggle"
                  id="detalleUsuarioToggle"
                  onchange="toggleUsuarioEstadoDesdeModal()"
                />
                <label for="detalleUsuarioToggle">
                  <span class="switch-x-text">Estado</span>
                  <span class="switch-x-toggletext">
                    <span class="switch-x-unchecked"
                      ><span class="switch-x-hiddenlabel">Estado: </span
                      >Desactivar</span
                    >
                    <span class="switch-x-checked"
                      ><span class="switch-x-hiddenlabel">Estado: </span
                      >Activar</span
                    >
                  </span>
                </label>
              </div>
              <span
                class="detalle-usuario-estado-texto"
                id="detalleUsuarioEstadoTexto"
                >Usuario Activo</span
              >
            </div>
          </div>

          <!-- Alerta de bloqueo (visible solo si está bloqueado) -->
          <div
            class="detalle-usuario-bloqueado-alert"
            id="detalleUsuarioBloqueadoAlert"
            style="display: none"
          >
            <i class="fas fa-exclamation-triangle"></i>
            <div>
              <strong>Usuario bloqueado por múltiples intentos fallidos</strong>
              <small id="detalleUsuarioBloqueadoHasta"
                >Bloqueado hasta: --</small
              >
            </div>
          </div>
        </div>

        <!-- Acciones del modal -->
        <div class="modal-usuario-detalle-acciones">
          <button
            type="button"
            class="btn-detalle-usuario btn-detalle-secundario"
            onclick="cerrarModalDetalleUsuario()"
          >
            <i class="fas fa-arrow-left"></i> Cerrar
          </button>
          <button
            type="button"
            class="btn-detalle-usuario btn-detalle-desbloquear"
            id="btnDesbloquearDesdeDetalle"
            style="display: none"
            onclick="desbloquearUsuarioDesdeModal()"
          >
            <i class="fas fa-unlock"></i> Desbloquear
          </button>
          <button
            type="button"
            class="btn-detalle-usuario btn-detalle-primario"
            onclick="editarUsuarioDesdeModal()"
          >
            <i class="fas fa-pen-to-square"></i> Ir a editar
          </button>
        </div>
      </div>
    </div>

    <!-- Download Spinner - Dot Spinner (hidden by default) -->
    <div
      id="downloadSpinner"
      class="download-spinner-overlay"
      style="display: none"
    >
      <div class="dot-spinner">
        <div class="dot-spinner__dot"></div>
        <div class="dot-spinner__dot"></div>
        <div class="dot-spinner__dot"></div>
        <div class="dot-spinner__dot"></div>
        <div class="dot-spinner__dot"></div>
        <div class="dot-spinner__dot"></div>
        <div class="dot-spinner__dot"></div>
        <div class="dot-spinner__dot"></div>
      </div>
      <p class="download-text">Generando documento...</p>
    </div>

    <!-- Modal para Ver Detalles de Servicios -->
    <div
      id="modalDetallesServicio"
      class="modal-detalles"
      style="display: none"
    >
      <div class="modal-detalles-overlay" onclick="cerrarModalDetalles()"></div>
      <div class="modal-detalles-contenido">
        <div class="modal-detalles-header">
          <h3 id="modalDetallesTitulo">Detalles del Servicio</h3>
          <button class="modal-detalles-cerrar" onclick="cerrarModalDetalles()">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-detalles-body" id="modalDetallesBody">
          <!-- El contenido se llenará dinámicamente -->
        </div>
      </div>
    </div>

    <!-- Modal para crear nueva sábana -->
    <div
      id="modalNuevaSabana"
      class="modal-detalles modal-nueva-sabana"
      style="display: none"
    >
      <div
        class="modal-detalles-overlay"
        onclick="cerrarModalNuevaSabana()"
      ></div>
      <div class="modal-detalles-contenido">
        <div class="modal-detalles-header">
          <h3>Crear nueva sábana</h3>
          <button
            class="modal-detalles-cerrar"
            onclick="cerrarModalNuevaSabana()"
          >
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-detalles-body">
          <p class="modal-nueva-sabana-texto">
            Define el servicio que se realizará.
          </p>

          <!-- Radio toggle: Nuevo / Existente -->
          <div class="servicio-tipo-toggle">
            <label class="radio-toggle-option">
              <input
                type="radio"
                name="tipoServicio"
                value="nuevo"
                checked
                onchange="toggleTipoServicioModal()"
              />
              <span class="radio-label"
                ><i class="fas fa-plus-circle"></i> Nuevo servicio</span
              >
            </label>
            <label class="radio-toggle-option">
              <input
                type="radio"
                name="tipoServicio"
                value="existente"
                onchange="toggleTipoServicioModal()"
              />
              <span class="radio-label"
                ><i class="fas fa-list"></i> Servicio registrado</span
              >
            </label>
          </div>

          <!-- Input para nombre del nuevo servicio -->
          <div id="contenedorNuevoServicio" class="form-group-modal">
            <label for="inputNombreServicio">
              <i class="fas fa-tag"></i> Nombre del servicio
            </label>
            <input
              type="text"
              id="inputNombreServicio"
              class="brutalist-input"
              placeholder="Ej: Cambio de Lámparas LED"
              maxlength="50"
            />
          </div>

          <!-- Select para servicios existentes -->
          <div
            id="contenedorServicioExistente"
            class="form-group-modal"
            style="display: none"
          >
            <label for="selectServicioNuevaSabana">
              <i class="fas fa-clipboard-list"></i> Selecciona el servicio
            </label>
            <div class="select-container premium-select">
              <select id="selectServicioNuevaSabana">
                <!-- Opciones dinámicas -->
              </select>
              <i class="fas fa-chevron-down icono-select"></i>
            </div>
          </div>

          <!-- Campo de notas (opcional) -->
          <div class="form-group-modal" style="margin-top: 1rem">
            <label for="inputNotasSabana">
              <i class="fas fa-sticky-note"></i> Notas (opcional)
            </label>
            <textarea
              id="inputNotasSabana"
              class="brutalist-input"
              rows="2"
              placeholder="Ej: Priorizar edificio Alfa..."
              maxlength="500"
              style="resize: vertical; min-height: 60px"
            ></textarea>
          </div>

          <!-- Campo de fecha programada -->
          <div class="form-group-modal" style="margin-top: 1rem">
            <label for="inputFechaProgramadaSabana">
              <i class="fas fa-calendar-alt"></i> Fecha programada
            </label>
            <input
              type="date"
              id="inputFechaProgramadaSabana"
              class="brutalist-input"
            />
            <small class="input-hint"
              >La fecha en que se realizará el servicio</small
            >
          </div>

          <!-- Switch para archivar sábana actual -->
          <div class="form-group-modal" style="margin-top: 1rem">
            <label class="switch-container">
              <span class="switch-label">
                <i class="fas fa-archive"></i>
                <input type="checkbox" id="switchArchivarActual" hidden />
                <span class="switch-slider"></span>
                Archivar sábana actual
              </span>
            </label>
            <div
              id="alertaArchivarActual"
              class="modal-nueva-sabana-alerta"
              style="margin-top: 0.75rem; margin-left: 0; display: none"
            >
              <i class="fas fa-archive"></i>
              <span
                >La sábana vigente se moverá al historial en automático.</span
              >
            </div>
          </div>

          <div class="modal-nueva-sabana-actions">
            <button
              class="btn-modal-cancel"
              type="button"
              onclick="cerrarModalNuevaSabana()"
            >
              Cancelar
            </button>
            <button
              class="btn-modal-confirm"
              type="button"
              id="btn-confirmar-nueva-sabana"
              onclick="confirmarNuevaSabana()"
            >
              Crear sábana
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal: Historial de Sábanas -->
    <div
      id="modalHistorialSabanas"
      class="modal-detalles modal-historial"
      style="display: none"
    >
      <div
        class="modal-detalles-overlay"
        onclick="cerrarModalHistorial()"
      ></div>
      <div class="modal-detalles-contenido modal-historial-contenido">
        <div class="modal-detalles-header">
          <h3><i class="fas fa-history"></i> Historial de Sábanas</h3>
          <button
            class="modal-detalles-cerrar"
            onclick="cerrarModalHistorial()"
          >
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-detalles-body">
          <p class="modal-historial-descripcion">
            <i class="fas fa-info-circle"></i>
            Haz clic en una sábana para cargarla y consultarla.
          </p>
          <div id="listaHistorialSabanas" class="historial-lista">
            <!-- Lista dinámica -->
            <div class="historial-loading">
              <i class="fas fa-spinner fa-spin"></i> Cargando historial...
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal: Confirmar Eliminación (Paso 1) -->
    <div
      id="modalConfirmarEliminar"
      class="modal-detalles modal-eliminar"
      style="display: none"
    >
      <div
        class="modal-detalles-overlay"
        onclick="cerrarModalConfirmarEliminar()"
      ></div>
      <div class="modal-detalles-contenido modal-eliminar-contenido">
        <div class="modal-detalles-header">
          <h3>
            <i class="fas fa-exclamation-triangle"></i> Confirmar eliminación
          </h3>
          <button
            class="modal-detalles-cerrar"
            onclick="cerrarModalConfirmarEliminar()"
          >
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-detalles-body">
          <div class="modal-eliminar-warning">
            <i class="fas fa-trash-alt"></i>
            <div>
              <p class="modal-eliminar-texto">
                ¿Estás seguro de eliminar
                <strong id="nombreSabanaEliminar1"></strong>?
              </p>
              <p class="modal-eliminar-alerta">
                Esta acción es <strong>PERMANENTE</strong> y eliminará todos los
                datos asociados.
              </p>
            </div>
          </div>
        </div>
        <div class="modal-eliminar-actions">
          <button
            class="btn-modal-cancel"
            type="button"
            onclick="cerrarModalConfirmarEliminar()"
          >
            Cancelar
          </button>
          <button
            class="btn-modal-danger"
            type="button"
            onclick="abrirModalValidarEliminar()"
          >
            <i class="fas fa-arrow-right"></i> Continuar
          </button>
        </div>
      </div>
    </div>

    <!-- Modal: Validar Eliminación (Paso 2) -->
    <div
      id="modalValidarEliminar"
      class="modal-detalles modal-eliminar"
      style="display: none"
    >
      <div
        class="modal-detalles-overlay"
        onclick="cerrarModalValidarEliminar()"
      ></div>
      <div class="modal-detalles-contenido modal-eliminar-contenido">
        <div class="modal-detalles-header">
          <h3><i class="fas fa-shield-alt"></i> Validar eliminación</h3>
          <button
            class="modal-detalles-cerrar"
            onclick="cerrarModalValidarEliminar()"
          >
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-detalles-body">
          <div class="modal-eliminar-warning">
            <i class="fas fa-exclamation-circle"></i>
            <div>
              <p class="modal-eliminar-texto">
                Para confirmar la eliminación de
                <strong id="nombreSabanaEliminar2"></strong>, completa los
                siguientes campos:
              </p>
            </div>
          </div>

          <div class="form-group-modal">
            <label for="inputConfirmarEliminar">
              <i class="fas fa-keyboard"></i> Escribe
              <strong>"eliminar"</strong> para confirmar
            </label>
            <div class="input-eliminar-wrapper">
              <input
                type="text"
                id="inputConfirmarEliminar"
                class="brutalist-input input-eliminar"
                placeholder=""
                autocomplete="off"
                spellcheck="false"
                data-target="eliminar"
                oninput="
                  actualizarPlaceholderPersistente(
                    'inputConfirmarEliminar',
                    'placeholderConfirmarEliminar',
                    'eliminar'
                  );
                  validarCamposEliminar();
                "
              />
              <span
                class="input-eliminar-placeholder"
                id="placeholderConfirmarEliminar"
                >eliminar</span
              >
            </div>
            <small class="input-hint">Escribe exactamente: eliminar</small>
          </div>

          <div class="form-group-modal">
            <label for="inputNombreSabanaEliminar">
              <i class="fas fa-file-alt"></i> Escribe el nombre de la sábana
            </label>
            <div class="input-eliminar-wrapper">
              <input
                type="text"
                id="inputNombreSabanaEliminar"
                class="brutalist-input input-eliminar"
                placeholder=""
                autocomplete="off"
                spellcheck="false"
                data-target=""
                oninput="
                  actualizarPlaceholderPersistente(
                    'inputNombreSabanaEliminar',
                    'placeholderNombreSabana',
                    ''
                  );
                  validarCamposEliminar();
                "
              />
              <span
                class="input-eliminar-placeholder"
                id="placeholderNombreSabana"
              ></span>
            </div>
            <small class="input-hint" id="hintNombreSabana"
              >Debe coincidir exactamente</small
            >
          </div>
        </div>
        <div class="modal-eliminar-actions">
          <button
            class="btn-modal-cancel"
            type="button"
            onclick="cerrarModalValidarEliminar()"
          >
            Cancelar
          </button>
          <button
            class="btn-modal-danger"
            type="button"
            id="btnConfirmarEliminar"
            onclick="confirmarEliminarSabana()"
            disabled
          >
            <i class="fas fa-trash-alt"></i> Eliminar permanentemente
          </button>
        </div>
      </div>
    </div>

    <!-- Scripts principales -->
    <script src="js/sabana-functions.js"></script>
    <script src="js/background-manager.js"></script>
    <script src="js/app.js"></script>
    <script src="js/script.js"></script>
    <script src="js/enhanced-frontend.js"></script>
    <script src="js/notificaciones-blur.js"></script>

    <!-- Script para manejar el switch Avería/Alerta -->
    <script>
      // Función para manejar el cambio del switch
      function handleTipoSwitchChange(switchElement) {
        console.log(
          '🔄 Switch cambió a:',
          switchElement.checked ? 'ALERTA' : 'AVERÍA'
        );

        const tipoHidden = document.getElementById('tipoHiddenLateral');
        const alertaFields = document.getElementById('alertaFieldsContainer');

        if (!alertaFields) {
          console.error('❌ No se encontró alertaFieldsContainer');
          return;
        }

        if (switchElement.checked) {
          // Modo ALERTA - MOSTRAR campos
          console.log('✅ Mostrando campos de alerta');
          if (tipoHidden) tipoHidden.value = 'rutina';
          // Usar la clase 'show' para activar la animación CSS
          alertaFields.classList.add('show');
          alertaFields.style.display = 'block';

          // Hacer los campos requeridos cuando es alerta
          const horaInput = document.getElementById('horaRutinaLateral');
          const fechaInput = document.getElementById('diaAlertaLateral');
          if (horaInput) horaInput.setAttribute('required', 'required');
          if (fechaInput) fechaInput.setAttribute('required', 'required');
        } else {
          // Modo AVERÍA - OCULTAR campos
          console.log('⚠️ Ocultando campos de alerta');
          if (tipoHidden) tipoHidden.value = 'normal';
          // Remover clase y ocultar
          alertaFields.classList.remove('show');
          alertaFields.style.display = 'none';

          // Remover atributo required cuando es avería
          const horaInput = document.getElementById('horaRutinaLateral');
          const fechaInput = document.getElementById('diaAlertaLateral');
          if (horaInput) horaInput.removeAttribute('required');
          if (fechaInput) fechaInput.removeAttribute('required');
        }
      }

      // Hacer la función global
      window.handleTipoSwitchChange = handleTipoSwitchChange;

      console.log('✅ Función handleTipoSwitchChange cargada');
    </script>

    <!-- <script src="script_index.js"></script> -->
    <!-- script_index.js deshabilitado - usando solo app-loader.js -->

    <!-- IndexedDB Manager - Sistema de almacenamiento local -->
    <script type="module">
      // Importar módulos de IndexedDB
      import dbManager from './js/indexeddb-manager.js';
      import storageHelper from './js/storage-helper.js';

      // Exponer globalmente para compatibilidad
      window.dbManager = dbManager;
      window.storageHelper = storageHelper;

      // Inicializar IndexedDB
      console.log('🔧 [IndexedDB] Inicializando sistema de almacenamiento...');

      Promise.all([dbManager.init(), storageHelper.init()])
        .then(() => {
          console.log('✅ [IndexedDB] Sistema de almacenamiento inicializado');

          // 1. Cargar Habitaciones
          console.log('🌐 Cargando módulo de habitaciones...');
          const scriptHabitaciones = document.createElement('script');
          scriptHabitaciones.type = 'module';
          scriptHabitaciones.src =
            'js/app-loader-habitaciones.js?v=' + Date.now();

          // 2. Cargar Espacios Comunes (NUEVO)
          const scriptEspacios = document.createElement('script');
          scriptEspacios.type = 'module';
          scriptEspacios.src =
            'js/app-loader-espacios-comunes.js?v=' + Date.now();

          scriptHabitaciones.onload = () => {
            console.log('✅ Módulo de habitaciones cargado');
            // Cargar espacios después de habitaciones para asegurar orden
            document.head.appendChild(scriptEspacios);
          };

          scriptEspacios.onload = () => {
            console.log('✅ Módulo de espacios comunes cargado');

            // 3. Cargar App Loader Principal (Solo después de cargar los módulos de soporte)
            const scriptLoader = document.createElement('script');
            scriptLoader.type = 'module';
            scriptLoader.src = 'js/app-loader.js?v=' + Date.now();

            scriptLoader.onload = () =>
              console.log('✅ App loader cargado exitosamente');
            scriptLoader.onerror = (error) =>
              console.error('❌ Error cargando app loader:', error);

            document.head.appendChild(scriptLoader);
          };

          // Iniciar la cadena cargando habitaciones
          document.head.appendChild(scriptHabitaciones);
        })
        .catch((error) => {
          console.error('❌ [IndexedDB] Error al inicializar:', error);
          console.warn('⚠️ Usando carga directa por fallback');

          // Fallback simple: cargar todo directamente
          const s1 = document.createElement('script');
          s1.type = 'module';
          s1.src = 'js/app-loader-habitaciones.js';
          const s2 = document.createElement('script');
          s2.type = 'module';
          s2.src = 'js/app-loader-espacios-comunes.js';
          const s3 = document.createElement('script');
          s3.type = 'module';
          s3.src = 'js/app-loader.js';
          document.head.append(s1, s2, s3);
        });
    </script>

    <!-- Service Worker temporalmente deshabilitado para debugging -->
    <script>
      /*
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./js/sw.js')
                .then((registration) => {
                    console.log('SW registrado exitosamente: ', registration);
                })
                .catch((registrationError) => {
                    console.log('Fallo en registro SW: ', registrationError);
                });
        });
    }
    */
      console.log('🔧 Service Worker deshabilitado para debugging');

      // Eliminar Service Worker existente si existe
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker
          .getRegistrations()
          .then(function (registrations) {
            for (let registration of registrations) {
              registration.unregister();
              console.log('🗑️ Service Worker eliminado:', registration);
            }
          });
      }

      function buscarAlertas(listas, listasDescr, valorInputBuscar, mensaje) {
        let listaHistorialAlertasDescr = listasDescr;
        let listaHistAlertasDescr = [];

        listas.forEach((alerta) => {
          alerta.style.display = 'none';
        });

        listaHistorialAlertasDescr.forEach((element) => {
          listaHistAlertasDescr.push(element.textContent);
        });

        let countVisible = 0;
        listas.forEach((alerta, index) => {
          const descripcion = listaHistAlertasDescr[index];
          if (
            descripcion.toLowerCase().includes(valorInputBuscar.toLowerCase())
          ) {
            alerta.style.display = 'block';
            countVisible++;
          } else {
            alerta.style.display = 'none';
          }
        });

        if (countVisible === 0) {
          if (valorInputBuscar === '') {
            document.getElementById(
              'mensaje-no-alertas-emitidas'
            ).style.display = 'block';
            mensaje.style.display = 'none';
          } else {
            document.getElementById(
              'mensaje-no-alertas-emitidas'
            ).style.display = 'none';
            mensaje.style.display = 'block';
          }
        } else {
          document.getElementById('mensaje-no-alertas-emitidas').style.display =
            'none';
          mensaje.style.display = 'none';
        }
      }
    </script>
    <!-- Modal Detalle Tarea -->
    <div
      id="modalDetalleTarea"
      class="modal-detalles"
      style="display: none"
      aria-hidden="true"
    >
      <div class="modal-detalles-overlay" data-close-modal></div>
      <div class="modal-detalles-contenido tarea-modal">
        <div class="modal-detalles-header">
          <div>
            <p class="modal-detalles-subtitulo">
              Código • <span id="tareaModalId">task-000</span>
            </p>
            <h3 id="tareaModalTitulo">Detalle de tarea</h3>
          </div>
          <button class="modal-detalles-cerrar" data-close-modal>
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-detalles-body tarea-modal-body">
          <!-- Pills de estado y prioridad -->
          <div class="tarea-modal-heading">
            <h4>Prioridad y Estado</h4>
            <div class="tarea-modal-pills-inline">
              <span
                id="tareaModalPrioridad"
                class="tarea-modal-pill prioridad-media"
                >●MEDIA</span
              >
              <span
                id="tareaModalEstado"
                class="tarea-modal-pill estado-pendiente"
                >PENDIENTE</span
              >
            </div>
          </div>

          <!-- Descripción -->
          <p id="tareaModalDescripcion" class="tarea-modal-descripcion">
            Descripción completa de la tarea seleccionada.
          </p>

          <!-- Grid de información -->
          <div class="tarea-modal-grid">
            <div class="tarea-modal-info">
              <strong>Ubicación</strong>
              <span id="tareaModalUbicacion">--</span>
            </div>
            <div class="tarea-modal-info">
              <strong>Responsable</strong>
              <span id="tareaModalResponsable">--</span>
            </div>
            <div class="tarea-modal-info">
              <strong>Vencimiento</strong>
              <span id="tareaModalVence">--</span>
            </div>
            <div class="tarea-modal-info">
              <strong>Rol asignado</strong>
              <span id="tareaModalRol">--</span>
            </div>
            <div class="tarea-modal-info">
              <strong>Próxima acción</strong>
              <span id="tareaModalNextStep">--</span>
            </div>
            <div class="tarea-modal-info">
              <strong>Fecha de creación</strong>
              <span id="tareaModalUltimoMovimiento">--</span>
            </div>
          </div>

          <!-- Tags -->
          <div class="tarea-modal-heading">
            <h4>Tags</h4>
            <div id="tareaModalTags">
              <span class="tarea-tag-mini">General</span>
            </div>
          </div>

          <!-- Documentos Adjuntos -->
          <div class="tarea-modal-heading">
            <h4>Documentos Adjuntos</h4>
            <button
              type="button"
              class="btn-add-adjunto"
              id="btnAgregarAdjuntoModal"
              title="Agregar archivo"
            >
              <i class="fas fa-plus"></i>
            </button>
          </div>
          <div id="tareaModalAdjuntos" class="adjuntos-chips-container">
            <!-- Chips de archivos adjuntos se cargan dinámicamente -->
            <span class="adjuntos-empty-msg"
              ><i class="fas fa-paperclip"></i> Sin adjuntos</span
            >
          </div>
          <input
            type="file"
            id="inputAdjuntoModal"
            style="display: none"
            accept=".pdf,.docx,.doc,.md,.txt,.csv,.xls,.xlsx,.xlsm,.png,.jpg,.jpeg,.gif,.webp,.zip,.rar,.7z,.tar,.gz"
          />

          <!-- Sección de Servicios Asignados -->
          <div
            class="tarea-modal-servicios"
            id="tareaModalServiciosContainer"
            style="display: none"
          >
            <div class="tarea-modal-heading">
              <h4>Servicios Asignados</h4>
            </div>
            <div id="tareaModalServicios" class="servicios-asignados-lista">
              <!-- Los servicios se cargarán dinámicamente aquí -->
            </div>
          </div>

          <!-- Acciones del modal -->
          <div class="tarea-modal-actions">
            <button class="tarea-modal-btn" data-close-modal>
              <i class="fas fa-arrow-left"></i> Cerrar
            </button>
            <button class="tarea-modal-btn btn-primary" id="tareaModalAccion">
              <i class="fas fa-play"></i> Accionar
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Crear Tarea -->
    <div
      id="modalCrearTarea"
      class="modal-detalles modal-editar-tarea modal-crear-tarea"
      style="display: none"
      aria-hidden="true"
    >
      <div class="modal-detalles-overlay" data-close-crear-modal></div>
      <div class="modal-detalles-contenido tarea-edit-modal">
        <div class="modal-detalles-header">
          <div>
            <p class="modal-detalles-subtitulo">Nueva tarea</p>
            <h3>Crear</h3>
          </div>
          <button class="modal-detalles-cerrar" data-close-crear-modal>
            <i class="fas fa-times"></i>
          </button>
        </div>
        <form id="formCrearTarea" class="tarea-edit-form">
          <input type="hidden" id="tareaCrearCuartoId" name="cuarto_id" />
          <div class="tarea-edit-grid">
            <div class="form-group full">
              <label for="crearTareaNombre">Nombre de la tarea</label>
              <input type="text" id="crearTareaNombre" name="nombre" required />
            </div>
            <div class="form-group full">
              <label for="crearTareaDescripcion">Descripción completa</label>
              <textarea
                id="crearTareaDescripcion"
                name="descripcion"
                rows="3"
                required
              ></textarea>
            </div>
            <div class="form-group full">
              <label for="crearTareaUbicacion">Ubicación</label>
              <input
                type="text"
                id="crearTareaUbicacion"
                name="ubicacion"
                placeholder="Ej: Habitación 101, Lobby, etc."
              />
            </div>
            <div class="form-group">
              <label for="crearTareaPrioridad">Prioridad</label>
              <div
                class="select-container premium-select"
                data-semaforo-wrapper="prioridad"
              >
                <span
                  id="semaforoPrioridadCrear"
                  class="semaforo-indicator semaforo-select-indicator"
                  aria-hidden="true"
                ></span>
                <select
                  id="crearTareaPrioridad"
                  name="prioridad"
                  required
                  data-semaforo-select="prioridad"
                >
                  <option value="baja">Baja</option>
                  <option value="media" selected>Media</option>
                  <option value="alta">Alta</option>
                </select>
                <i class="fas fa-chevron-down icono-select"></i>
              </div>
            </div>
            <div class="form-group">
              <label for="crearTareaEstado">Estado</label>
              <select id="crearTareaEstado" name="estado" required>
                <option value="pendiente" selected>Pendiente</option>
                <option value="en_proceso">En proceso</option>
                <option value="completada">Completada</option>
                <option value="cancelada">Cancelada</option>
              </select>
            </div>
            <div class="form-group">
              <label for="crearTareaFecha">Fecha límite</label>
              <input
                type="date"
                id="crearTareaFecha"
                name="fecha_limite"
                required
              />
            </div>
            <div class="form-group">
              <label for="crearTareaResponsable">Responsable</label>
              <select
                id="crearTareaResponsable"
                name="responsable_id"
                required
              ></select>
            </div>
          </div>

          <div class="tarea-edit-section">
            <div class="section-header">
              <div class="section-header-title">
                <h4>Agregar servicios a la tarea</h4>
                <p>Asigna esta tarea a servicios existentes.</p>
              </div>
              <div class="section-header-controls">
                <label
                  class="toggle-filtro-responsable"
                  title="Mostrar solo servicios del responsable seleccionado"
                >
                  <input type="checkbox" id="toggleFiltroResponsable" checked />
                  <span class="toggle-slider"></span>
                  <span class="toggle-label-text">Filtrar por responsable</span>
                </label>
                <input
                  type="search"
                  id="buscarServiciosTarea"
                  placeholder="Buscar..."
                />
              </div>
            </div>
            <div id="listaServiciosCrear" class="lista-servicios-seleccion">
              <p class="mensaje-vacio">Cargando servicios...</p>
            </div>
          </div>

          <div class="tarea-edit-section">
            <div class="section-header">
              <h4>Tags</h4>
              <p>Añade etiquetas para clasificar.</p>
            </div>
            <div class="tarea-edit-tags" id="tagsListCrear"></div>
            <div class="tarea-edit-tags-input">
              <input
                type="text"
                id="crearTareaTags"
                placeholder="Escribe un tag..."
              />
              <button
                type="button"
                id="btnAgregarTagCrear"
                class="btn-cuarto-action btn-tarea-light"
              >
                <i class="fas fa-plus"></i> Añadir
              </button>
            </div>
          </div>

          <div class="tarea-edit-section">
            <div class="section-header">
              <h4>Archivos adjuntos</h4>
              <p>Sube evidencia o documentación.</p>
            </div>
            <div class="tarea-edit-attachments">
              <label class="upload-label" for="crearTareaAdjuntos">
                <i class="fas fa-cloud-upload-alt"></i>
                <span>Seleccionar archivos</span>
              </label>
              <input
                type="file"
                id="crearTareaAdjuntos"
                multiple
                style="display: none"
              />
              <div id="filePreviewCrear" class="file-preview"></div>
              <p class="adjuntos-hint">
                <i class="fas fa-info-circle"></i>
                Los archivos se subirán automáticamente al crear la tarea.
              </p>
            </div>
          </div>

          <div class="tarea-edit-actions">
            <button
              type="button"
              class="btn-cuarto-action btn-tarea-light"
              data-close-crear-modal
            >
              Cancelar
            </button>
            <button type="submit" class="btn-cuarto-action btn-tarea-primary">
              <i class="fas fa-plus"></i> Crear Tarea
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal Editar Tarea -->
    <div
      id="modalEditarTarea"
      class="modal-detalles modal-editar-tarea"
      style="display: none"
      aria-hidden="true"
    >
      <div
        class="modal-detalles-overlay"
        onclick="cerrarModal('modalEditarTarea')"
      ></div>
      <div class="modal-detalles-contenido tarea-edit-modal">
        <div class="modal-detalles-header">
          <div>
            <p class="modal-detalles-subtitulo">Editar tarea</p>
            <h3 id="tareaEditTitulo">TAREA</h3>
          </div>
          <button
            class="modal-detalles-cerrar close"
            onclick="cerrarModal('modalEditarTarea')"
          >
            <i class="fas fa-times"></i>
          </button>
        </div>
        <form id="formEditarTarea" class="tarea-edit-form">
          <input type="hidden" id="tareaEditId" name="id" />
          <div class="tarea-edit-grid">
            <div class="form-group full">
              <label for="editarTareaNombre">Nombre de la tarea</label>
              <input
                type="text"
                id="editarTareaNombre"
                name="nombre"
                required
              />
            </div>
            <div class="form-group full">
              <label for="editarTareaDescripcion">Descripción completa</label>
              <textarea
                id="editarTareaDescripcion"
                name="descripcion"
                rows="3"
                required
              ></textarea>
            </div>
            <div class="form-group full">
              <label for="editarTareaUbicacion">Ubicación</label>
              <input
                type="text"
                id="editarTareaUbicacion"
                name="ubicacion"
                placeholder="Ej: Habitación 101, Lobby, etc."
              />
            </div>
            <div class="form-group">
              <label for="editarTareaPrioridad">Prioridad</label>
              <div
                class="select-container premium-select"
                data-semaforo-wrapper="prioridad"
              >
                <span
                  id="semaforoPrioridadEditar"
                  class="semaforo-indicator semaforo-select-indicator"
                  aria-hidden="true"
                ></span>
                <select
                  id="editarTareaPrioridad"
                  name="prioridad"
                  required
                  data-semaforo-select="prioridad"
                >
                  <option value="alta">Alta</option>
                  <option value="media">Media</option>
                  <option value="baja">Baja</option>
                </select>
                <i class="fas fa-chevron-down icono-select"></i>
              </div>
            </div>
            <div class="form-group">
              <label for="editarTareaEstado">Estado</label>
              <select id="editarTareaEstado" name="estado" required>
                <option value="pendiente">Pendiente</option>
                <option value="en_proceso">En proceso</option>
                <option value="completada">Completada</option>
                <option value="cancelada">Cancelada</option>
              </select>
            </div>
            <div class="form-group">
              <label for="editarTareaFecha">Fecha límite</label>
              <input
                type="date"
                id="editarTareaFecha"
                name="fecha_limite"
                required
              />
            </div>
            <div class="form-group">
              <label for="editarTareaResponsable">Responsable</label>
              <select
                id="editarTareaResponsable"
                name="responsable_id"
                required
              ></select>
            </div>
          </div>

          <!-- Sección de Mantenimientos/Servicios -->
          <div class="tarea-edit-section">
            <div class="section-header">
              <div class="section-header-title">
                <h4>Servicios asignados</h4>
                <p>Gestiona los servicios vinculados a esta tarea.</p>
              </div>
              <div class="section-header-controls">
                <label
                  class="toggle-filtro-responsable"
                  title="Mostrar solo servicios del responsable seleccionado"
                >
                  <input
                    type="checkbox"
                    id="toggleFiltroResponsableEditar"
                    checked
                  />
                  <span class="toggle-slider"></span>
                  <span class="toggle-label-text">Filtrar por responsable</span>
                </label>
                <input
                  type="search"
                  id="buscarServiciosTareaEditar"
                  placeholder="Buscar..."
                />
              </div>
            </div>
            <div id="listaServiciosEditar" class="lista-servicios-seleccion">
              <p class="mensaje-vacio">Cargando servicios...</p>
            </div>
          </div>

          <div class="tarea-edit-section">
            <div class="section-header">
              <h4>Tags</h4>
              <p>Añade o elimina etiquetas.</p>
            </div>
            <div class="tarea-edit-tags" id="tagsListEditar"></div>
            <div class="tarea-edit-tags-input">
              <input
                type="text"
                id="editarTareaTags"
                placeholder="Escribe un tag..."
              />
              <button
                type="button"
                id="btnAgregarTagEditar"
                class="btn-cuarto-action btn-tarea-light"
              >
                <i class="fas fa-plus"></i> Añadir
              </button>
            </div>
          </div>

          <div class="tarea-edit-section">
            <div class="section-header">
              <h4>Archivos adjuntos</h4>
              <p>Sube o revisa la documentación.</p>
            </div>
            <!-- Chips de adjuntos existentes (editable) -->
            <div
              id="adjuntosEditarChips"
              class="adjuntos-chips-container adjuntos-editable"
            >
              <!-- Se cargan dinámicamente al abrir el modal de edición -->
            </div>
            <div class="tarea-edit-attachments">
              <label class="upload-label" for="editarTareaAdjuntos">
                <i class="fas fa-cloud-upload-alt"></i>
                <span>Seleccionar archivos</span>
              </label>
              <input
                type="file"
                id="editarTareaAdjuntos"
                multiple
                style="display: none"
              />
              <div id="filePreviewEditar" class="file-preview"></div>
              <p class="adjuntos-hint">
                <i class="fas fa-info-circle"></i>
                Los archivos nuevos se subirán al guardar los cambios.
              </p>
            </div>
          </div>

          <div class="tarea-edit-actions">
            <button
              type="button"
              class="btn-cuarto-action btn-tarea-danger"
              id="btnEliminarTarea"
              onclick="confirmarEliminarTarea()"
            >
              <i class="fas fa-trash-alt"></i> Eliminar
            </button>
            <div style="flex: 1"></div>
            <button
              type="button"
              class="btn-cuarto-action btn-tarea-light"
              onclick="cerrarModal('modalEditarTarea')"
            >
              Cancelar
            </button>
            <button type="submit" class="btn-cuarto-action btn-tarea-primary">
              <i class="fas fa-save"></i> Guardar
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal Advertencia Edición -->
    <div
      id="modalAdvertenciaEdicion"
      class="modal-detalles"
      style="display: none"
      aria-hidden="true"
    >
      <div class="modal-detalles-overlay" data-close-advertencia-modal></div>
      <div class="modal-detalles-contenido">
        <div class="modal-detalles-header">
          <div>
            <h3>No se puede editar esta tarea</h3>
          </div>
          <button class="modal-detalles-cerrar" data-close-advertencia-modal>
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-detalles-body">
          <div
            style="
              display: flex;
              flex-direction: column;
              align-items: center;
              padding: 2rem 0;
              text-align: center;
            "
          >
            <i
              class="fas fa-exclamation-triangle"
              style="
                font-size: 3rem;
                color: var(--amarillo, #f59e0b);
                margin-bottom: 1rem;
              "
            ></i>
            <p style="font-size: 1.1rem; margin-bottom: 1rem; font-weight: 600">
              Esta tarea está completada o cancelada
            </p>
            <p
              style="color: var(--texto-secundario, #666); margin-bottom: 2rem"
            >
              Contacta a administrador o supervisor para realizar cambios en
              esta tarea.
            </p>
            <button
              type="button"
              class="btn-modal-advertencia btn-tarea-primary"
              data-close-advertencia-modal
            >
              Entendido
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Preview Adjunto -->
    <div
      id="modalPreviewAdjunto"
      class="modal-detalles modal-preview-adjunto"
      style="display: none"
      aria-hidden="true"
    >
      <div class="modal-detalles-overlay" data-close-preview-modal></div>
      <div class="modal-detalles-contenido preview-adjunto-contenido">
        <div class="modal-detalles-header">
          <div>
            <p class="modal-detalles-subtitulo">Vista previa</p>
            <h3 id="previewAdjuntoNombre">documento.pdf</h3>
          </div>
          <button class="modal-detalles-cerrar" data-close-preview-modal>
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-detalles-body preview-adjunto-body">
          <div id="previewAdjuntoContainer" class="preview-container">
            <!-- Preview dinámico (imagen, iframe PDF, o ícono genérico) -->
            <div class="preview-placeholder">
              <i class="fas fa-file-alt"></i>
              <p>Vista previa no disponible</p>
            </div>
          </div>
          <div class="preview-adjunto-info">
            <span id="previewAdjuntoTipo"><i class="fas fa-file"></i> PDF</span>
            <span id="previewAdjuntoTamano"
              ><i class="fas fa-database"></i> 2.4 MB</span
            >
            <span id="previewAdjuntoFecha"
              ><i class="fas fa-calendar"></i> 10 Dic 2025</span
            >
            <span id="previewAdjuntoSubidoPor"
              ><i class="fas fa-user"></i> Usuario</span
            >
          </div>
        </div>
        <div class="preview-adjunto-actions">
          <button
            type="button"
            class="tarea-modal-btn"
            data-close-preview-modal
          >
            <i class="fas fa-arrow-left"></i> Volver
          </button>
          <button
            type="button"
            class="tarea-modal-btn btn-primary"
            id="btnDescargarAdjunto"
          >
            <i class="fas fa-download"></i> Descargar
          </button>
        </div>
      </div>
    </div>

    <link rel="stylesheet" href="views/tareas/tareas-cards.css" />
    <link rel="stylesheet" href="views/tareas/tareas-timeline.css" />
    <script src="views/tareas/tareas-module.js"></script>
    <!-- GitHub Direct Downloads -->
    <script src="js/github-downloads.js"></script>
    <!-- Checklist API y módulo -->
    <script src="js/checklist-api.js"></script>
    <!-- <script src="views/checklist/checklist-tab.js"></script> -->
  </body>
</html>
